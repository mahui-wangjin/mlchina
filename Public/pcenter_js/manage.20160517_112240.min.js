// JavaScript Document
var _manApi = {
    _delDiscuss: "/post/api:80",
    _refuseJoin: "/post/api:82"
};
$(document).ready(function() {
    _heigh._equal();
    _joinMana._init();
    $(".join_shai_nr a").click(function() {
        $(".join_shai_k_txt").text($(this).children('span').text());
        $(".join_shai_nr").css({
            "display": "none"
        });
        setTimeout(function() {
            $(".join_shai_nr").css({
                "display": ""
            });
        }, 100);
        _joinMana._init();
        _like._init();
    });
    if (!_user._login()) {
        _user._toLogin();
        return;
    }
    $(".join_nr_zu .t").click(function(){
    	if($(this).parent().attr("class")=="join_nr_zu thisOver"){
    		$(this).parent().toggleClass("thisOver");
    	}else{
    		$(".join_nr_zu").removeClass("thisOver");
    		$(this).parent().addClass("thisOver");
    	}
    });
    $(".joinStylepic img").each(function(){
		var x = $(this).width(), y = $(this).height();
		if(x>y&&y!=80){
			$(this).height(80);
		}else if(x<y&&x!=80){
			$(this).width(80);
		}else if(x==y && x!=80){
            $(this).width(80);
        }
	});
    $(".joinStylepic img").click(function(){
		$("#picTc").css({"visibility":"hidden","display":"block","position":"absolute","z-index":-1});
		$("#picTc .b img").remove();
		var _src = $(this).attr("src");
		$("#picTc .b").append('<img src="'+_src+'">');
		var x = $("#picTc .b img").width(),y = $("#picTc .b img").height();
		if(x>y){
			if(x>580){
				$("#picTc .b img").width(580);
				$("#picTc .b img").height(y/x*580);
			}
		}else{
			if(y>580){
				$("#picTc .b img").height(580);
				$("#picTc .b img").width(x/y*580);
			}
		}
		_tc._show("picTc");
		$("#picTc").css({"visibility":"visible"});
	});
    $(".joinStylenr p input").click(function(){
    	return false;
    });
    $(".ma_outside").css("min-height",$(window).height()-$(".header_public").height()-$(".footer_gray").height()-26);
});
/*报名管理*/
var _joinMana = {
    _init: function() {
        $(".join_shai_k_txt").text() == "全部报名" ? $(".joinAll").hide() : $(".joinAll").show();
    }
};

    /**评论前判断*/
var _reviewBeforeLogin = {
    _mark: function(value) {
        _t._set("review_before_login_" + _info._type + "_" + _info._id, value);
    },
    _continue: function() {
        if (_t._get("review_before_login_" + _info._type + "_" + _info._id) != "") {
            setTimeout(function() {
                _reviewBeforeLogin._post();
                _review._post();
            }, 500);
        }
    },
    _setTemp: function(key, value) {
        _t._set(key + "_" + _info._type + "_" + _info._id, value);
    },
    _getTemp: function(key) {
        return _t._get(key + "_" + _info._type + "_" + _info._id);
    },
    _post: function() {
        _review._replyUid = _reviewBeforeLogin._getTemp("review_replyUid");
        _review._questionId = _reviewBeforeLogin._getTemp("review_questionId");
        $("#dt_review_form_content").attr("placeholder", "继续评论/回复：");
        _reviewBox._show();
    }
};
/**评论*/
var _review= {
    _replyUid: "0",
    _pId:"0",
    _isRootDiscuss : true,
    _post: function() {
        var _content = _emo._toCode(_._trim($("#dt_review_form_content").val()));
        if (_content == "") {
            return;
        }
        if (_._len(_content) > 200) {
            _toast._show("评论请在100字以内");
            return;
        }
        if (!_user._login()) {
            _user._toLogin();
            return;
        }
        _loading._show("请稍候");
        _review._isRootDiscuss = true;
        _$(_api3._review, "h_share_uid=" + _info._shareUid + "&info_id=" + _info._id + "&info_type=" + _info._type + "&content=" + _._encode(_content), _review._ok);
    },
    _post2:function(){
        var _thisNext=_info._type.replace(_info._type,function($1){
            return $1?($1.substring(0,1).toUpperCase() + $1.substring(1)):'';
         });
        var _content=_._trim($("#dt_review_form_content2").val());
        if(_content==""){return;}
        if(_._len(_content)>200){_toast._show("评论请在100字以内");return;}
        if(!_user._login()){
            _reviewBeforeLogin._mark("1");
            _user._toLogin(_thisNext);
            return;
        }
        _loading._show("请稍候");
        _review._isRootDiscuss = false;
        _$(_api3._review,"h_share_uid="+_info._shareUid+"&pId="+ _review._pId+"&info_id="+_info._id+"&info_type="+_info._type+"&replyUserid="+_review._replyUid+"&content="+_._encode(_content),_review._ok);
    },
    _ok: function(json, code) {
        _loading._hide();
        if (json.state.toString() != "0") {
            _toast._show(json.error, function() {
                _user._error(json.state, "review");
            });
            return;
        }
        var _data = json.discuss_info;
        var _item = _review._itemDom(_data.id,_data.pId, _data.userId, _data.userName, _data.replyUserId, _data.replyUserName,_data.date, _data.discussContent, _data.user_pic,_data.originalId);
        
        if(_review._isRootDiscuss){
            $("#dt_review_main").html(_item+$("#dt_review_main").html());
            $("#dt_review_main").show();
        }else{
            $("#dt_review_box2").parent().after(_item);//添加评论
            $("#dt_review_box2").remove();//移除输入框
        }
        var _total = 1;
        if ($("#review_total").attr("id") != undefined) {
            _total = parseInt($("#review_total").html()) + 1;
        }
        $("#review_total").html(_total);
        if (_info._typ == "job") {
            $("#review_total").html(_total);
        }
        //_scroollTop._top(".main_manager_ping_t", 500, 200);
        $("#dt_review_form_content").val("");
        _reviewBox._setTemp("review_content", "");
        _reviewBox._hide();
        _heigh._equal();
        $("li.manager_ping_li_empty").hide();
        _heigh._equal();
    },
    _okFromApp: function(json) {
        _review._ok(json, 200);
    },
    _itemDom: function(id, pId, userId, userName, replyUserId, replyUserName, date, discussContent, userImg, originalId) {
    	var _thisNext = _info._type.replace(_info._type, function($1) {
    	    return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    	});

        var _item = '<li id="mana_review_'+originalId+'" class="manager_ping_li' + (replyUserId != "0"?" dt_review_repeat":"") + '"> '
        _item += '<div class="dt_review_icon"><a target="_blank" class="manager_ping_pic" href="/timeline/' + userId + '">'
        if (userImg == "") {
      	    _item += '<img class="default_img" src="' + _imgCdn + '/static_v4/images/other/face_default_200.png" />';
      	  } else {
      	    _item += '<img class="default_img"  src="' + userImg + '" onerror="this.src=\'' + _imgCdn + '/static_v4/images/other/face_default_200.png\'" />';
      	  }
        _item += '</a> ' + '<div class="manager_ping_txt"><p class="manager_ping_nr">' + '<a href="/timeline/' + userId + '" target="_blank">' + userName + '</a> ';
        if (replyUserId != "0") {
            _item += '   回复 <a target="_blank" href="/timeline/' + replyUserId + '">' + replyUserName + ':</a>  '
        }
        _item += ' : ' +  discussContent + ' </p>' + '  <p class="manager_ping_time"><span>' + date + '</span>'
        _item += '<a class="manager_ping_add" title="评论" onclick="_reviewBox._rePost2(\'' + userId + '\',\'' + userName + '\',\'' +  userName +  '\',\'mana_review_'  + originalId + '\',\'' + pId + '\')" ></a> '
        _item += ' <a class="manager_ping_del" title="删除" onclick="_delreview._show(\'' + originalId+ '\')" href="javascript:void(0)"></a></p></div></li>'
        return _item;
    }
};
/**评论框*/ //_delreview._show(${dis.discussId!});"
var _reviewBox= {
    _currentTop: 0,
    _show: function(uName, nick) {
        if (!_user._login() && !window.localStorage) {
            _user._toLogin('');
            return;
        }
        _cover._show("cover2");
        $("#dt_review_box").show();
        _reviewBox._inputed();
        $("#dt_review_form_content").focus();
        $("#dt_review_form_content").val(_reviewBox._getTemp("review_content"));
        $("#cover2").bind("click", _reviewBox._hide);
    },
    _hide: function() {
        if (_user._useIOs()) {
            $("body").css({
                "height": "auto",
                "overflow": "auto",
                "margin-top": "0px"
            });
        }
        _cover._hide("cover2");
        $("#dt_review_box").hide();
        _emo._hide("dt_review_box_emo");
        $("body").css({
            "height": "auto",
            "overflow": "auto"
        });
    },
    _post: function() {
        _review._replyUid = 0;
        var _reviewFrom = $("#dt_review_form_content")[0];
        _reviewFrom.setAttribute("placeholder", "评论：");
        if (_info._type == "job") {
            _reviewFrom.setAttribute("placeholder", "留言：");
        }
        _reviewBox._show();
    },
    _rePost: function(uId, uName, nick) {
        _review._replyUid = uId;
        var _reviewFrom = $("#dt_review_form_content")[0];
        _reviewFrom.setAttribute("placeholder", "回复" + uName + "：");
        _reviewBox._show(uName, nick);
    },
    _touch: function() {
        $("#cover2").unbind("click");
        setTimeout(function() {
            $("#cover2").bind("click", _reviewBox._hide);
        }, 1000);
        _emo._hide("dt_review_box_emo");
        $("#dt_review_form_content").focus();
    },
    _focus: function() {
        _emo._hide("dt_review_box_emo");
        with($("#dt_review_form_content")) {
            var _value = $("#dt_review_form_content").val();
            $("#dt_review_form_content").val("");
            $("#dt_review_form_content").val(_value);
        }
    },
    _blur: function() {
        _reviewBox._setTemp("review_content", $("#dt_review_form_content").val());
        _reviewBeforeLogin._setTemp("review_replyUid", _review._replyUid);
    },
    _inputed: function() {
        $("#dt_review_form_post").attr("class", _._trim($("#dt_review_form_content").val()) == "" ? "button_1_disabled" : "button_1");
    },
    _setTemp: function(key, value) {
        _t._set(key + "_" + _info._type + "_" + _info._id + "_" + _review._replyUid, value);
    },
    _getTemp: function(key) {
        return _t._get(key + "_" + _info._type + "_" + _info._id + "_" + _review._replyUid);
    },
    _showEmo: function() {
        _emo._show("dt_review_box_emo", function(index) {
            $("#dt_review_form_content").val($("#dt_review_form_content").val() + _emo._text[index]);
            _reviewBox._inputed();
            _reviewBox._blur();
        });
    },
    _ping:function() {
    	$(".dt_review_edit").show();
    	$(".manager_ping_li_empty").hide();
    },
    _rePost2:function(uId,uName,nick,item_id,pId){
    	var _html = "<div id=\"dt_review_box2\"><div id=\"dt_review_box_input2\"><p><textarea id=\"dt_review_form_content2\" name=\"\" cols=\"\" rows=\"\" oncut=\"return false\" oncopy=\"return false\" oncontextmenu=\"return false\" onpaste=\"return false\" placeholder=\"回复"+uName+"：\"></textarea></p></div><button onclick=\"_review._post2()\" class=\"button_1_disabled\" id=\"dt_review_form_post2\">回复</button></div>";
        _review._replyUid=uId;
        _review._pId = pId;
        if($("#"+item_id).children("#dt_review_box2").size() == 0){
            $("#"+item_id).append(_html);
        }
        $("#"+item_id).siblings("li").children("#dt_review_box2").remove();
        $("#dt_review_form_content2").focus();
    }
};

/*删除评论*/
var _delreview= {
    _id: "",
    _show: function(dis_id) {
        _delreview._id = dis_id;
        _tc._show("ts_popbox1");
    },
    _hide: function() {
        _tc._hide("ts_popbox1");
    },
    _defineDel: function() {

        _$(_manApi._delDiscuss, "discuss_id=" + _delreview._id, _delreview._ok);
    },
    _ok: function(json, code) {
        if (code != 200) {
            return;
        }
        var result = json.result;
        if (result == "0") {
        	var m = $("#mana_review_" + _delreview._id).attr("class");
        	if(m=="manager_ping_li"){
        		$("#review_total_new").html(parseInt($("#review_total_new").html()) - 1);
        		if($("#review_total_new").html()==0){
        			$("li.manager_ping_li_empty").show();
        		}
        	}
            $("#mana_review_" + _delreview._id).remove();
            _tc._hide("ts_popbox1");
            _heigh._equal();
            $("#review_total").text(parseInt($("#review_total").text()) - 1);
            
        }
        if ($("#dt_review_main li").length == 1 && $("#dt_review_edit").is(":hidden")) {
            $("li.manager_ping_li_empty").show();
        }
    }
};
    /**赞相关*/
var _like= {
    _total: 0,
    _index: 1,
    _nowTime: 0,
    _post: function() {
        if (!_user._login()) {
            _user._toLogin('');
            return;
        }
        _$(_api3._like, "h_share_uid=" + _info._shareUid + "&info_type=" + _info._type + "&info_id=" + _info._id, _like._ok);
    },
    _ok: function(json, code) {
        if (code != 200) {
            _like._likeFailed();
            return;
        }
        if (json.state.toString() != "0") {
            _toast._show(json.error, function() {
                _user._error(json.state, "like");
            });
            return;
        }
        _like._liked();

        var _item = _like._itemDom(json.user.user_id, json.user.user_name);
        $("#dt_like_list").show();
        $("#dt_like_list p").prepend(_item);
        if ($("#dt_like_count").attr("id") != undefined) {
            $("#dt_like_count").html(parseInt($("#dt_like_count").html()) + 1);
        } else {
            $("#dt_like_count").html("1");
        }
        _heigh._equal();
        
        $(".manager_ping_null_2").hide();
    },
    _getFlag: false,
    _get: function() {
        if (_like._getFlag) {
            return;
        }
        _like._getFlag = true;
        var _src = $("#img_dt_like").attr("src");
        $("#img_dt_like").attr("src", _src.replace("dt_like2.png", "dt_like_yes.png"));
        _$(_api3._likeList, "info_type=" + _info._type + "&info_id=" + _info._id + "&page_num=" + _like._index + "&now_time=" + _like._nowTime + "&count=" + _like._total, _like._getOk);
    },
    _getOk: function(json, code) {
        if (code != 200 || (code == 200 && json.state != "0")) {
            _like._getFlag = false;
            return;
        }
        var _data = json.likeArray,
            _len = _data.length;
        var _isLike = json.isLike;
        _like._nowTime = json.nowTime;
        if (_like._index == 1) {
            if (_isLike == 1) {
                _like._liked();
            }
            _like._total = json.total;
        }
        if ($("#dt_like_more").attr("href") != undefined) {
            $("#dt_like_more").remove();
        }
        for (var i = 0; i < _len; i++) {
            $("#dt_like_list").append(_like._itemDom(_data[i].userId, _data[i].nickName));
        }
        if (json.nextState == "1") {
            var _a = "<a id=\"dt_like_more\" class=\"dt_nick\" ontouchstart=\"\" onclick=\"_like._get()\" href=\"javascript:void(0)\">&nbsp;&nbsp;更多…</a>";
            $("#dt_like_list").append(_a);
            _like._getFlag = false;
            _like._index++;
        }

    },
    _liked: function() {
        if ($(".main_manager_zan_t span").attr('click') == "") {
            return;
        }
        var _src = $("#img_dt_like").attr("src");
        $("#img_dt_like").attr("src", _src.replace("dt_like2.png", "dt_like_yes.png"));
        $(".main_manager_zan_t span").attr("click", "");
    },
    _likeFailed: function() {
        $("#dt_like").html("<a ontouchstart='' href='javascript:_like._post()'>" + $("#dt_like").html() + "</a>");
    },
    _itemDom: function(userId, userName) {
        var _a = "<a ontouchstart=''href=\"/timeline/" + userId + "?hdb_from=" + (_user._inMobile() ? "WapHome" : "PCHome") + "\" id=\"dt_like_list_" + userId + "\">" + userName + "</a>";
        return _a;
    },
    _init: function() {
        setTimeout(_like._get, 500);
    }
};

/*高度设置*/
var _heigh= {
    _equal: function() {
        $(".main_manager_left").height($(".main_manager_right").height());
    }
};

/*报名审核*/
var _joinCheck= {
    _id: "",
    _show: function(join_id) {
        _joinCheck._id = join_id;
        _tc._show("ts_popbox2");
    },
    _hide: function() {
        _tc._hide("ts_popbox2");
    },
    _defineDel: function() {
        _$(_manApi._refuseJoin, "info_type=" + _info._type + "&info_id=" + _info._id + "&join_id=" + _joinCheck._id, _joinCheck._ok);
    },
    _ok: function(json, code) {
        if (code != 200) {
            return;
        }
        var state = json.state;
        if (state == "0") {
            $("#mana_join_id_" + _joinCheck._id).remove();
            $("#join_data span").text($("#join_data span").text() - 1);
            _tc._hide("ts_popbox2");
            _heigh._equal();
        }
    }
};

/*分页*/
var _fenY= {
    _init: function() {
        var ye = parseInt($("#fenY_input").val());
        if(ye!=""&&ye!=0){
            var big = $("#numBig").text();
            var link = $("#thisLink").text();
            if(ye>big){ye=big;}
            link += ye;
            _g(link);
        }
        
    }
};

/*删除活动*/
var _delhd= {
    _id: "",
    _type:"",
    _actionType:1,
    _show:function(id,type,actionType){
    	_delhd._id = id;
    	_delhd._type = type;
    	_delhd._actionType = 1;
    	_tc._show('tc_delhd');
    },
    _defineDel: function() {
        _$(_api3._delhd, "infoId=" + _delhd._id + "&infoType="+ _delhd._type + "&actionType=" + _delhd._actionType, _delhd._ok);
    },
    _ok: function(json, code) {
        if (code != 200) {
            return;
        }
        _tc._hide('tc_delhd');
        if(_delhd._type=="article"){
            _toast._show("删除成功！",_g("/manage/manage_article_vote?type=1"));
        }else if(_delhd._type=="vote"){
            _toast._show("删除成功！",_g("/manage/manage_article_vote?type=2"));
        }else{
            _toast._show("删除成功！",_g("/manage/post_info"));
        }
    },
    _ifJoin: function(id,type,actionType){
    	_delhd._id = id;
    	_delhd._type = type;
    	_delhd._actionType = 1;
    	_$(_api3._ifJoinZero, "info_id=" + _delhd._id, _delhd._ifJoinOk);
    },
    _ifJoinOk: function(json, code) {
        if (code != 200) {
            return;
        }
        var ifJoin = json.hasJoin;
        if(ifJoin==1){
        	_tc._show("tc_delhd_party");
        }else{
        	$("#tc_delhd_party .bj_white .tc_delhd_top").html("活动删除后，将不可恢复，您确定继续删除吗？");
        	_tc._show("tc_delhd_party");
        }
    }
};