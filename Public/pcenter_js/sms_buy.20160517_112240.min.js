	/**
	 * 短信购买信息
	 * ms-controller="sms_buy_controller"
	 */
   	var sms_buy_model = avalon.define({   //avalon model定义方式
   		$id : "sms_buy_controller",
		sms_price : 0.00,		//短信单价
		sms_show : "", 			//短信优惠展示
		sms_fixed_prompt : "",	//提示信息
		sms_discount : "",  	//短信折扣

		sms_buy_num : 0,		//短信购买数量
		sms_buy_num_show : null,		//短信用于前台展示的数量
		sms_buy_money: 0.00,	//付款金额

		sms_show_list : [],		//短信优惠展示转换后的数据
		sms_discount_map : new Object(),	//短信优惠折扣转换后的数据
		sms_discount_array : new Array(), 	//短信折扣数量从小到大排序

        sms_discount_now : "",//当前折扣
        sms_discount_value : "",//减免费用


		/**
		 * 循环结束之后的回调函数，
		 */
		repeatCallback : function(){

		},

		/**
		 * 文本框改变数值。计算当前充值金额
		 */
		calculateSmsBuyChange : function(el){
			if(parseFloat(el)<1){
				sms_buy_model.sms_buy_num_show = 0;
			}

			sms_buy_model.sms_buy_num = sms_buy_model.sms_buy_num_show;
			sms_buy_model.calculateSmsBuy();
		},

		/**
		 * 点击按钮计算当前充值金额
		 */
		calculateSmsBuyClick : function(sms_buy_num){
			sms_buy_model.sms_buy_num = sms_buy_num;
			sms_buy_model.sms_buy_num_show = null;
			sms_buy_model.calculateSmsBuy();
		},

		/**
		 * 计算当前充值金额
		 */
		calculateSmsBuy : function(){
			var vm = sms_buy_model;

			var discount = 1.0; 	//默认无折扣
			vm.sms_discount_array.forEach(function(el) {   //遍历数据，取出对象数据
				if(parseInt(vm.sms_buy_num) >= parseInt(el)){
					discount = vm.sms_discount_map[el];
				}

			});

            vm.sms_discount_now = discount * 10;

			//付款金额 = 单价* 短信数量 * 折扣
			vm.sms_buy_money = (vm.sms_price * vm.sms_buy_num * discount).toFixed(2);//保存两位小数

            //已折扣金额
            vm.sms_discount_value = (vm.sms_price * vm.sms_buy_num - vm.sms_buy_money).toFixed(2);

            $("#pay_Ma").html("");

            //$("#pay_Btn_ali a").attr("href", "/alipay_pc_sms_order?sms_count=" + vm.sms_buy_num + "&sms_price=" + vm.sms_buy_money)

		},

   		/**
   		 * 查询购买信息
   		 */
		init : function(){
			require(['avalon', "mmRequest"], function(avalon) {  //使用avalon自带的ajax需在使用前加载mmRequest
				avalon.ajax({
					type:"get",
					url:"/post/api:137",
					dataType: 'json',
					cache: false
				}).done(function(data) {
					//avalon.log(data);

					sms_buy_model.sms_price = data.sms_price;
					sms_buy_model.sms_show = data.sms_show;
					sms_buy_model.sms_fixed_prompt = data.sms_fixed_prompt;
					sms_buy_model.sms_discount = data.sms_discount;


					sms_buy_model.convertSmsShow(sms_buy_model);

					sms_buy_model.convertSmsDiscount(sms_buy_model);

					//初试化第一个充值的金额
					sms_buy_model.calculateSmsBuyClick(sms_buy_model.sms_show_list[0].sms_num);

				});
			});
   		},

		/**
		 * 将字符传切分，转换为json格式
		 */
		convertSmsShow : function(vm){

			var list_sms_package = new Array();

			var sms_packages = vm.sms_show.split('#');

			for (var i=0;i<sms_packages.length;i++){

				var sms_package_columns = sms_packages[i].split('@');

				var sms_name = sms_package_columns[0];	//短信包名
				var sms_content = sms_package_columns[1];	//短信包说明
				var sms_num = sms_package_columns[2];	//短信包数量

				var sms_package_json = {"sms_name":sms_name,"sms_content":sms_content,"sms_num":sms_num};
				list_sms_package.push(sms_package_json);
			}

			//按条数从小到大排序
			list_sms_package.sort(function(a,b){
				return a.sms_num-b.sms_num;
			});

			vm.sms_show_list = list_sms_package;
		},

		/**
		 * 将折扣字符传切分，转换为json格式，和
		 */
		convertSmsDiscount : function(vm){

			var json_str = "{";			//用来生成json的字符串

			var discounts = vm.sms_discount.split('#');

			for (var i=0;i<discounts.length;i++){

				var discounts_columns = discounts[i].split('@');

				var sms_num = discounts_columns[0];			//短信数量
				var sms_discount = discounts_columns[1];	//短信折扣

				json_str = json_str + '"'+sms_num+'":"'+sms_discount+'",';

				vm.sms_discount_array.push(sms_num);
			}

			json_str = json_str.substr(0,json_str.length-1);
			json_str = json_str+"}";

			vm.sms_discount_map = eval('(' + json_str + ')');
			vm.sms_discount_array.sort(function(a,b){return a-b});

		}


   	});
