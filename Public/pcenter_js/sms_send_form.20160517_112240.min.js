	/**
	 * 短信群发表单
	 * ms-controller="sms_send_form_controller"
	 */
   	var sms_send_form_model = avalon.define({   //avalon model定义方式
   		$id : "sms_send_form_controller",

		sms_fixed_size : 67,	//单条短信长度
		sms_total_size : 0,  	//短信最大长度
		sms_quantity : 0,		//短信余额
		pay_item_list : [],		//所有收费项及对应的报名信息

		//不需要查询的值
		sms_content : "",		//短信内容
		sms_length : 0,			//短信文字长短
		sms_size : 0, 			//短信条数
		sms_send_quantity : 0, 	//本次消耗
		is_recharge : false,	//是否需要充值

		select_persion: 0,		//选中人数
		select_mobile : 0,  	//选中手机号
		select_join_ids : "",		//选中手机号的报名信息ID

		info_id : "",			//信息ID
		/**
   		 * 循环结束之后的回调函数，
   		 */
   		repeatCallback : function(){
   			
   		},


		/**
		 * 提交群发短信
		 */
		commitSmsSendForm : function(){

			var vm = sms_send_form_model;

			//(1)校验
			if(vm.select_mobile<=0){
				_toast._show('有效手机号为0个，无法发送');
				return;
			}

			if(vm.sms_content==""){
				_toast._show('短信内容不能为空');
				return;
			}

			if(vm.is_recharge){  //需要充值f
				_toast._show('您的短信余额不足，请充值');
				return;
			}

			//(2)提交

			var sms_data = vm.info_id+"#party#1#"+vm.select_join_ids;  //信息ID+信息类型+1（选中）+报名ID

			var param = "info_id="+vm.info_id+"&content="+ vm.sms_content+"&sms_data="+sms_data;

			_$("/post/api:138",param,vm.commitCallBack);

		},

		//提交完成的回调函数
		commitCallBack : function(data,state_code){

			if(state_code==200){
				location.href = "/manage/sms_user_log_list?info_id="+sms_send_form_model.info_id;
			}
		},


   		/**
   		 * 计算当前短信长度,计算是否当前余额是否够用
   		 */
		calculateSms : function(){

			var vm = sms_send_form_model;
			
			if(vm.sms_content.length>vm.sms_total_size){
				vm.sms_content = vm.sms_content.substr(0,vm.sms_total_size);
				_toast._show('短信内容不能超过'+vm.sms_total_size+'字');
			}
			

			//计算文本为几条短信(输入/单条长度)
			vm.sms_size = Math.ceil(vm.sms_content.length/vm.sms_fixed_size);

			//计算勾选人数和有手机号的人数

			var select_persion = 0;
			var select_mobile = 0;
			var select_join_ids = "";

			vm.pay_item_list.forEach(function(pay_item_map) {   //遍历数据，取出对象数据,如果有一个没勾选则取消全选
				pay_item_map.join_info_list.forEach(function(join) {   //遍历数据，取出对象数据,如果有一个没勾选则取消全选

					if(join.checked==true){
						if(join.join_mobile!=""){

							//计算手机号是否为中国大陆手机号
							var phone = /^1([38]\d|4[57]|5[0-35-9]|7[06-8]|8[89])\d{8}$/;
							if(!phone.test(join.join_mobile)){
							}else{
								select_mobile = select_mobile+1;
								select_join_ids = select_join_ids + join.join_party_id+",";
							}
						}
						select_persion = select_persion+1;
					}
				});
			});

			vm.select_persion = select_persion;
			vm.select_mobile = select_mobile;
			vm.select_join_ids = select_join_ids.substr(0,select_join_ids.length-1);

			//计算总的发送条数
			vm.sms_send_quantity = vm.sms_size * vm.select_mobile;

			//计算是否需要充值
			if(vm.sms_send_quantity>vm.sms_quantity){
				vm.is_recharge = true;
			}else{
				vm.is_recharge = false;
			}


			//avalon.log("当前短信条数 :"+vm.sms_size+"  "+"发送总条数 :"+vm.sms_send_quantity+" " +
			//" 当前余额："+vm.sms_quantity+" 是否需要充值："+vm.is_recharge);
		},


		/**
		 * 勾选报名信息
		 * @param join_info 当前点击的报名信息
		 * @param pay_item  当前点击的报名信息对应的收费项
		 */
		clickJoinInfo : function(join_info,pay_item_map){
			join_info.checked = !join_info.checked;

			//当前收费项全选
			var all_checked_temp = true;

			pay_item_map.join_info_list.forEach(function(join) {   //遍历数据，取出对象数据,如果有一个没勾选则取消全选
				if(join.checked == false){
					all_checked_temp = false;
				}
			});
			pay_item_map.pay_item.checked = all_checked_temp;

			sms_send_form_model.calculateSms();
		},

		/**
		 * 勾选收费项(全选)
		 * @param event
		 */
		clickPayItem : function(pay_item_map){

			pay_item_map.pay_item.checked = !pay_item_map.pay_item.checked;

			pay_item_map.join_info_list.forEach(function(join) {   //遍历数据，取出对象数据,如果有一个没勾选则取消全选
				join.checked = pay_item_map.pay_item.checked;
			});


			sms_send_form_model.calculateSms();
		},

		/**
		 * 初始化payItem数据的checkbox=true
		 */
		initPayItemList : function(pay_item_list){

			pay_item_list.forEach(function(el) {   //遍历数据，取出对象数据
				el.pay_item['checked'] = true;

				el.join_info_list.forEach(function(join) {   //遍历数据，取出对象数据
					join['checked'] = true;
				});
			});

			sms_send_form_model.pay_item_list = pay_item_list;

			sms_send_form_model.calculateSms();
		},

		/**
		 * 初始化页面数据
		 */
		init : function(info_id){

			sms_send_form_model.info_id = info_id;

			require(['avalon', "mmRequest"], function(avalon) {  //使用avalon自带的ajax需在使用前加载mmRequest
				avalon.ajax({
					type:"get",
					url:"/post/api:136?info_id="+info_id,
					dataType: 'json',
					cache: false
				}).done(function(data) {
					//avalon.log(data);

					sms_send_form_model.sms_fixed_size = data.sms_fixed_size;
					sms_send_form_model.sms_total_size = data.sms_total_size;
					sms_send_form_model.sms_quantity = data.sms_quantity;
					sms_send_form_model.pay_item_list = sms_send_form_model.initPayItemList(data.pay_item_list);
				});
			});
		}



		///**
		// *  查询收费项对应的报名信息
		// */
		//queryJoinInfo : function(list_join_info){
		//	require(['avalon', "mmRequest"], function(avalon) {  //使用avalon自带的ajax需在使用前加载mmRequest
		//		avalon.ajax({
		//			type:"get",
		//			url:"/post/api:126?data_type=1",
		//			dataType: 'json',
		//			cache: false
		//		}).done(function(data) {
		//			//avalon.log(data);
        //
		//			list_join_info = data.list_join_info;
		//		});
		//	});
		//}
   	});

