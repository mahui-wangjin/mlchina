// JavaScript Document PC端详情页
var _detailApi3 = {
  _sendCode: "/post/api:66",
  _verifyCode: "/post/api:67",
  _care: "/post/api:77",
  _template: "/post/api:78"
};
/*滚动位置设置*/
var _scroollTop = {
  _top: function(id, delay, move) {
    var scroll_offset = $(id).offset();
    if (null != scroll_offset) {
      setTimeout(function() {
        var scroll_offset = $(id).offset();
        $("body,html").animate({
          scrollTop: scroll_offset.top
        }, move);
      }, delay);
    }
  }
};

/*管理*/
var _manage = {
  _init: function() {
    if (_user._login() && _user._id() == _info._postUid) {
      $("#dt_list_title_manage").bind("click", function(e) {
        e.stopPropagation();
      });
      $("#dt_list_title_manage").show();
    }
  },
  _installApp: function(install) {
    if (!install && _user._isappinstalled()) {
      return;
    }
    _alert._show("安装并使用互动吧App，你可以", "<p style='text-align:left;padding:0 10px;'>查看详细报名信息，审核报名用户，导出报名记录，现场扫码验票…</p>", "一键安装App", function() {
      _download(_link._appDownload);
    }, "关闭提示");
  }
};

var _guess = {
  _size: 20,
  _isDelay: true,
  _indexStr: "",
  _index: 1,
  _infoMsg: {
    party: "报名",
    article: "查看",
    job: "查看",
    recruit: "报名",
    vote: "投票",
    welfare: "参与"
  },
  _top: function() {
	$(".dt_guess_topR a").attr("target", "_blank");
    _$(_api3._guess, "location=2&index_str=" + _guess._indexStr + "&page_num=1&page_size=6&welfare_type=purchase&info_type=" + _info._type + "&info_id=" + _info._id, _guess._ok);
  },
  _ok: function(json, code) {
    if (json != null) {
      _guess._indexStr = json.index_str;
      var _hot = json.hotArray;
      var _len = _hot.length;
      _guess._index++;
      if (_len == 0) {
        return;
      }
      var _next = _hot[_len - 1];
      var _html = "";
      var _welare = json.welfare;
      for (var i = 0, _len = _welare.length; i < _len; i++) {
        _welare[i].title = _welare[i].nick_name + _welare[i].title;
        _html += _guess._addItem(_welare[i]);
      }
      var _pSize = 0;
      for (var i = 0; _pSize < 4 && i < _hot.length; i++) {
        var _d = _hot[i];
        if (!(_info._id == _d.infoId && _info._type == _d.infoType)) {
          _html += _guess._addItem(_d);
          _pSize++;
        }
      }
      var thisNext = _info._type.replace(_info._type, function($1) {
        return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
      });
      $("#dt_guess_list_main").append(_html);
      $("#dt_join_bar_menu").attr("href", "/" + _next.infoType + "/" + _next.infoId + "?hdb_from=PC" + thisNext + "Next");
    }
  },
  _addItem: function(item) {
    var _html = " <li><a target='_blank' href=\"/" + item.infoType + "/" + item.infoId + "-DInteraction.html\" class=\"dt_guess_list " + item.infoType + "\">" 
    + "<div class=\"dt_guess_list_icon\"><span></span></div>" 
    + "<div class=\"dt_guess_list_title dt_loadNew\"><span class=\"font03\">" + item.title + "</span></div>" 
    + "<p class=\"dt_guess_list_num font04\">" + item.hits + _guess._infoMsg[item.infoType] + "</p></a></li>";
    return _html;
  },
  _init: function() {
    _guess._top();
  },
  _trigger: function() {
    if (!_cover._flag && !_guess._flag && _guess._index <= 4 && ($("#dt_join_bar").offset().top + $("#dt_join_bar").height() + 5) > $(document).height()) {
      _guess._list();
    }
    _useCare._initFirst();
  },
  _list: function() {
    if (_guess._flag == true) {
      return;
    }
    _guess._flag = true;
    _guess._size = 20;
    if (_guess._index == 1) {
      _guess._flag = false;
      return;
    }
    if (_guess._index == 2) {
      _guess._size = 6;
    } else if (_guess._index == 3) {
      _guess._size = 10;
    }
    _bottomLoading._loading("guess_loading", "正在加载...");
    _$(_api3._guess, "location=2&index_str=" + _guess._indexStr + "&page_num=" + _guess._index + "&page_size=" + (_guess._size + 1), _guess._listOk);
  },
  _listOk: function(json, code) {
    if (!_user._inHudongba()) {
      _bottomLoading._hide("guess_loading");
    }
    var _state = json.state;
    if (code != 200 || (code == 200 && _state != "0")) {
      _bottomLoading._more("guess_loading", "网络错误，点击重新加载", _guess._list);
      return;
    }
    var _data = json.hotArray,
      _len = _data.length;
    _guess._indexStr = json.index_str;
    if (json.next_sate.toString() == "0" || _guess._index == 4) {
      $(window).unbind("scroll");
      $("#moreXinxi").show();
      _bottomLoading._hide("guess_loading");
    } else {
      _guess._flag = false;
      _guess._index++;
    }
    if (_len == 0) {
      return;
    }
    var _html = "";
    var _pSize = 0;
    for (var i = 0; _pSize < _guess._size && i < _len; i++) {
      var _d = _data[i];
      if (!(_info._id == _d.infoId && _info._type == _d.infoType)) {
        _html += _guess._addItem(_d);
        _pSize++;
      }
    }
    $("#dt_guess_list_main").append(_html);
  }
};

/* 加载详情页推荐数据 */
var _recommend = {
  _init: function() {
    _$(_api3._recommend, "info_type=" + _info._type + "&info_id=" + _info._id, _recommend._ok);
  },
  _ok: function(json, code) {
    if (code == 200) {
      var system = json.system;
      var next = json.next;
      //加载同类推荐数据
      var recommendList = json.sameKindRecommendList;
      var recommendLength = 0;
      if (recommendList != undefined) {
        recommendLength = recommendList.length;
      }
      if (recommendLength > 0) {
        var recommendHtml = "<div class='dt_guess'><ul class='dt_guess_list_main'>";
        for (var index = 0; index < recommendLength; index++) {
          var recommendItem = recommendList[index];
          recommendHtml += "<li>";
          recommendHtml += "<div class='dt_guess_list party'>";
          if(recommendItem.imageUrl=="" || recommendItem.imageUrl=="http://cdn.hudongba.com"){
        	  _reImage = _imgCdn + "/static_v4/images/other/face_default_105.png";
          }else{
        	  _reImage = recommendItem.imageUrl;
          }
          recommendHtml += "<div class='dt_guess_list_icon'><a href='/party/" + recommendItem.infoId36 + "-DInteraction.html' data-val='=info_rec' onmousedown='_a_link($(this))' target='_blank'><img src="+_reImage+" onerror=\"this.src='" + _imgCdn + "/static_v4/images/other/face_default_200.png'\" /></a></div>";
          recommendHtml += "<div class='dt_guess_list_title dt_loadNew'><a class='a_link' href='/party/" + recommendItem.infoId36 + "-DInteraction.html' data-val='=info_rec' onmousedown='_a_link($(this))' target='_blank'>" + recommendItem.infoTitle + "</a>";
          if(recommendItem.infoStartTime && recommendItem.infoStartTime != undefined){
              recommendHtml += "<div class='find_main_time'><img alt='' src='"+_imgCdn+"/static_v4/images/detail/icon_time.png'><p>"+recommendItem.infoStartTime+"</p></div>";
          }
          if(recommendItem.infoLocation && recommendItem.infoLocation != undefined){
              recommendHtml += "<div class='find_main_address'><img alt='' src='"+_imgCdn+"/static_v4/images/detail/icon_addr.png'><p><a href='javascript:void(0)'>"+recommendItem.infoLocation+"</a></p></div>";
          }
          recommendHtml += "<a class='dt_guess_list_see' href='/party/" + recommendItem.infoId36 + "-DInteraction.html?" + _HDB_POS_KEY +"=info_rec' target='_blank'>去看看</a></div>";
          recommendHtml += "<p class='dt_guess_list_num'>" + recommendItem.join + "报名</p>";
          recommendHtml += "</div>";
          recommendHtml += "</li>";
        }
        recommendHtml += "</ul>";
        recommendHtml += "</div>";
        $("#hd_xs").html(recommendHtml);
      } else {
    	  $("#xs").hide();
      }
      //加载精品推荐数据
      var hotList = json.hotList;
      var hotLength = 0;
      if (hotList != undefined) {
        hotLength = hotList.length;
      }
      if (hotLength > 0) {
        var hotHtml = "<div class='dt_guess dt_guess2'>" +
          "             <ul class='dt_guess_list_main'>";
        for (var index = 0; index < hotLength; index++) {
          if (recommendLength > 0 && index >= 5) {
            break;
          }
          var hotItem = hotList[index];
          hotHtml += "<li>";
          hotHtml += "<div class='dt_guess_list party'>";
          if(hotItem.imageUrl=="" || hotItem.imageUrl=="http://cdn.hudongba.com"){
        	  _hotImage = _imgCdn + "/static_v4/images/other/face_default_105.png";
          }else{
        	  _hotImage = hotItem.imageUrl;
          }
          hotHtml += "<div class='dt_guess_list_icon'><a href='/party/" + hotItem.infoId36 + "-DInteraction.html' data-val='=info_rec' onmousedown='_a_link($(this))' target='_blank'><img src="+_hotImage+" onerror=\"this.src='" + _imgCdn + "/static_v4/images/other/face_default_200.png'\" /></a></div>";
          hotHtml += "<div class='dt_guess_list_title dt_loadNew'><a class='a_link' href='/party/" + hotItem.infoId36 + "-DInteraction.html' data-val='=info_rec' onmousedown='_a_link($(this))' target='_blank'>" + hotItem.infoTitle + "</a>";
            if(hotItem.infoStartTime && hotItem.infoStartTime != undefined){
                hotHtml += "<div class='find_main_time'><img alt='' src='"+_imgCdn+"/static_v4/images/detail/icon_time.png'><p>"+hotItem.infoStartTime+"</p></div>";
            }
            if(hotItem.infoLocation && hotItem.infoLocation != undefined){
                hotHtml += "<div class='find_main_address'><img alt='' src='"+_imgCdn+"/static_v4/images/detail/icon_addr.png'><p><a href='javascript:void(0)'>"+hotItem.infoLocation+"</a></p></div>";
            }
            hotHtml += "<p class='dt_guess_list_num'>" + hotItem.join + "报名</p>";
            hotHtml += "<a class='dt_guess_list_see dt_guess_list_jxsee' href='/party/" + hotItem.infoId36 + "-DInteraction.html?" + _HDB_POS_KEY + "=info_rec' target='_blank'>去看看</a></div>";
          hotHtml += "</div>";
          hotHtml += "</li>";
        }
        hotHtml += "</ul>";
        hotHtml += "</div>";
        $("#hd_jx").html(hotHtml);
      } else {
    	  $('#jx').hide();
      }
      if($('#hd_xs > div').length>0){
    	  $("#hd_xs").hide();
      }else{
    	  $("#jx").addClass('thisOver');
      }
      if($('#hd_xs > div').length<=0 && $('#hd_jx > div').length<=0){
    	  $('.detail_tab').hide();
      }
      //下一篇
      if(next){
          $("#dt_join_bar_menu").attr("href", "/" + next.infoType + "/" + next.infoId36);
      }
    }
  }
};

/*已报名的弹框**/
var _joinBar = {
  _id: "",
  _center: function() {
    var w = $("body").width();
    var _left;
    if (w > 1000) {
      _left = (w - 1000) / 2 + "px";
    } else {
      _left = 0 + "px";
    }
    $("#dt_join_bar_list").css({
      "left": _left,
      "bottom": "0px",
      "z-index": "3000",
      "position": "fixed"
    });
  },
  _show: function(id) {
    _joinBar._id = id;
    _cover._show("cover2");
    _joinBar._center();
    var _url = "/get/api:qr?user_id=" + _user._id() + "&info_id=" + _info._id + "&info_type=" + _info._type + "&qr_type=paySuccessCardQR";
    $("#join_qr_img,#tc_2weima .weima2_2,#join_qr_img_2wm").attr("src", _url);

      //收费项活动不允许取消报名
      if($(".tc_c_feiLi li").length!=0){
    	if($(".tc_c_feiLi .select .ticket_money").html()!="免费"){ 
    		$(".tc_c_set").eq(0).hide();
    		$(".tc_c_set").eq(1).css("left",192+"px");
    	}
    }

      //活动已结束不允许取消报名
      if(_info._state == "8"){
          $(".tc_c_set").eq(0).hide();
          $(".tc_c_set").eq(1).css("left",192+"px");
      }

    _tc._show('dt_join_bar_list');
    $(window).bind("resize", _joinBar._center);
    $("#cover2").bind("click", _joinBar._hide);
  },
  _cancel: function() {
    _tc._hide('dt_join_bar_list');
    _joinAfter._id = "cancel_ok";
    _tc._show("cancel_ok");
  },
  _cancelYes: function() {
    _$(_api3._joinCancel, "info_id=" + _info._id + "&info_type=" + _info._type, _joinBar._cancelOk);
  },
  _cancelOk: function(json, code) {
    if (code != 200) {
      return;
    }
    var _join = parseInt($("#join_total").html()) - 1;
    if (_join == 0) {
      $("#dt_join_count").html("还没有人报名");
      $("#join_loading").hide();
    } else {
      $("#join_total").html(_join);
    }
    $("#detail_Joinnum .detail_Joinnum_t span").html(_join);
    $("#div_join_id_" + json.joinId).remove();
    _tc._hide('cancel_ok');
    //_scroollTop._top(".dt_join_menu_bg", 500, 200);
      //取消报名之后 所有的票 都能点击
    $(".tc_c_feiLi li").each(function(){
      $(this).bind("click", function(){
          $(this).addClass('select').siblings('li').removeClass('select');
      });
    });
    $('.tc_c_feiLi li').click(function(){
		if($(this).find(".num").html()=="已卖完"){
			$(".detail_t_join a,.xd_btn_r").css({"background-color":"#cccccc","cursor":"default"}).attr("onclick","");
		}else{
			$(".detail_t_join a,.xd_btn_r").css({"background-color":"#0099e9","cursor":"pointer"}).attr("onclick","_payItemBox._show('"+_info._type+"')");
		}
	});
    _sucess._show("取消成功");
    $("#dt_list_main li").show();
    if (_info._state == "3" || _info._state == "4" || _info._state == "5") {
      $("#dt_join_bar_title").html("<a href=\"javascript:void(0);\" class=\"xd_btn_r style03\"><img src=\"" + _info._img1Url + "/static_v4/images/detail/xd_icon_8.png\" alt=\"\"><span>报名已关闭</span></a>");
      $("div[name='detail_t_join']").html("<a href=\"javascript:void(0)\" class=\"style03\">报名已关闭</a>");
    } else {
      $("#dt_join_bar_title").html("<a href=\"javascript:void(0);\" class=\"xd_btn_r style01\" onclick=\"_payItemBox._next('party')\"><img src=\"" + _info._img1Url + "/static_v4/images/detail/icon_man2.png\" alt=\"\"><span>我要报名</span></a>");
      $("div[name='detail_t_join']").html("<a href=\"javascript:void(0)\" onclick=\"_payItemBox._next('party')\">我要报名</a>");
    }
    _payList._add();
  },
  _joinqQr: function() {
    _joinBar._hide();
    var _url = _api3._joinQr + "?user_id=" + _user._id() + "&info_id=" + _info._id + "&info_type=" + _info._type;
    $("#join_qr_img,#tc_2weima .weima2_2,#join_qr_img_2wm").attr("src", _url);
    _joinQr._show();
  },
  _hide: function() {
    $("#dt_join_bar_list").slideUp(500);
    _cover._hide("cover2");
  }
};

/*点击报名后*/
var _joinAfter = {
  _id: "",
  _center: function() {
    var _top = _._zero(_._client().bh - $("#" + _joinAfter._id).outerHeight()) / 2 + "px";
    var _left = _._zero(_._client().bw - $("#" + _joinAfter._id).outerWidth()) / 2 + "px";
    $("#" + _joinAfter._id).css({
      "left": _left,
      "bottom": _top,
      "z-index": "3000",
      "position": "fixed"
    });
  },
  _show: function(joinId) {
    if (joinId == "tc_chengNopay") {
      var _post = "发布投票";
      if (_info._type == "party") {
        _post = "发布活动";
      } else if (_info._type == "recruit") {
        _post = "发布招募";
      }
      $(".yediMore_l a").html(_post);
    }
    _cover._show("cover2");
    _joinAfter._id = joinId;
    _joinAfter._center();
    $("#" + joinId).show();
    $("#cover2").bind("click", _joinAfter._hide);
    if (joinId == "tc_payQuestion") {
      $("#cover2").unbind("click");
    }
    $(window).bind("resize", _joinAfter._center);
  },
  _hide: function() {
    _cover._hide("cover2");
    $("#" + _joinAfter._id).hide();
    _guess._trigger();
  },
  _joinAfterQr: function() {
    _joinAfter._hide();
    _joinQr._show();
  },
  _share: function() {
    _joinAfter._hide();
    _cover._show("cover2");
    _share._joinSucess();
  },
  _payAfter: function(json) {
    _joinAfter._hide();
    $("#dt_join_bar_title").html("<a onclick=\"_joinBar._show('party')\" href=\"javascript:void(0);\" class=\"xd_btn_r style02 party\"><img src=\" " + _info._img1Url + "/static_v4/images/detail/icon_man2.png\" alt=\"\" /><span>已报名</span></a>");
    $("div[name='detail_t_join']").html("<a href=\"javascript:void(0)\" class=\"style02\" onclick=\"_joinBar._show('party')\">已报名</a>");
    var _item = _joinLoading._addItem(json.join_user_id, json.big_name, json.user_pic, json.date, json.join_id);
    $("#dt_list_main").html(_item + $("#dt_list_main").html());
    $("#dt_join_menu_bg .dt_join_top").unbind("click");
    _joinBeforeLogin._mark("");
    _joinBox._hide();
    _backToRefresh._mark();
    _joinBox._clear();
    _scroollTop._top(".dt_join_menu_bg", 500, 200);
    _joinAfter._show("tc_chengNopay");
    if (_info._verify == "0") {
      dataForShare.title = "我报名了《" + dataForShare.title + "》，你也来看看吧";
      if (_user._inWeixin()) {
        onBridgeReady_new();
      }
    }
    if (_joinForm._toVerifyMobile(_joinForm._mobile)) {
      _info._verifyMobile = _info._verifyMobile + _joinForm._mobile + "|";
    }
  },
  _payQuestion: function() {
    _joinAfter._hide();
    _joinAfter._show('tc_noSuccess');
  },
  _paidSucces: function(orderId) {
    _g(_link._checkOrder + "?order_id=" + orderId);
  },
  _checkPayOrder: function() {
    var orderId = $("#orderId").val();
    _$(_api3._checkPayOrder, "order_id=" + orderId + "&info_id=" + _info._id + "&info_type=" + _info._type, _joinAfter._checkOrderOk);
  },
  _checkOrderOk: function(json, code) {
    if (code != 200) {
      return;
    };
    //支付成功
    if (json.payState == "0") {
      $("#tc_payQuestion").hide();
      _joinAfter._payAfter(json);
    } else {
      _joinAfter._payQuestion();
      $("#orderId").val(json.orderId);
    }
  },
  _repeat: function() {
    $("#form_order_repeat").attr("action", _link._alipay + "?order_id=" + $("#orderId").val());
  },
  _look: function() {
    _joinAfter._hide('tc_chengNopay');
    _g("#dt_join_menu_bg");
  },
  _look2: function() {
    _joinAfter._hide('tc_chengNopay');
    _g("#dt_vote");
  }
};

var _joinBeforeLogin = {
  _mark: function(value) {
    _t._set("join_before_login_" + _info._type + "_" + _info._id, value);
  },
  _continue: function() {
    if (_t._get("join_before_login_" + _info._type + "_" + _info._id) != "") {
      if (_info._join != 0) {
        _joinBeforeLogin._mark("");
        _backToRefresh._mark("");
        return;
      }
      if (!_user._login()) {
        _joinBeforeLogin._mark("");
        _backToRefresh._mark("");
        return;
      }
      var _mobile = _payItemBox._getTemp("party_pay_item_id_2");
      _joinForm._price = 0;
      if (_payItemBox._getTemp(_joinForm._id + "_pay_item_id") != "") {
        _joinForm._price = /\d*(\.)?\d*/.exec($("#li_pay_item_" + _payItemBox._getTemp(_joinForm._id + "_pay_item_id") + " .feiyong_r").html())[0];
      }
      _payItemBox._id = _joinForm._id;
      if (_joinForm._price != 0) {
        if (_joinForm._toVerifyMobile(_mobile)) {
          $("#hide_verify_mobile").val("1");
          _joinBox._id = _joinForm._id;
          _joinBox._initProperty();
          _joinForm._next();
          return;
        } else {
          _payItemBox._next();
        }
      } else {
        _joinBox._id = _joinForm._id;
        _joinBox._initProperty();
        if (_joinForm._toVerifyMobile(_mobile)) {
          $("#hide_verify_mobile").val("1");
          _joinForm._next();
          return;
        }
        _joinForm._post(_joinForm._id);
      }
    }
  }
};

/** TODO 报名*/
var _joinForm = {
  _mobile: "",
  _price: 0,
  _id: "",
  _img1Url: '',
  _toVerifyMobile: function(mobile) {
    if (_info._mobileVerify == "1" && mobile != "" && ("|" + _info._verifyMobile).indexOf("|" + mobile + "|") == -1) {
      return true;
    }
    return false;
	  },
  _post: function(id) {
    _joinForm._id = id;
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    var _hideMobile = $("#hide_verify_mobile").val();
    var _payItemId = "";
    if ($(".tc_c_feiLi li[class='select']").length > 0) {
      _payItemId = $(".tc_c_feiLi li[class='select']").attr("payitemid");
    }
    if (_joinForm._checkProperty()) {
      return false;
    }
    var _mobile = "";
    if ($("#input_pro_id_2").length != 0) {
      _mobile = _._trim($("#input_pro_id_2").val());
      _joinForm._mobile = _mobile;
    }
    var _enrollOption = _joinForm._getPorpertyValue();
    var _nick = _._trim($("#input_pro_id_1").val());
    /*不需要支付*/
    if ($(".tc_c_feiLi li[class='select']").length > 0) {
      _joinForm._price = $(".tc_c_feiLi li[class='select']").attr("payitemprice");
    }
    if (!_user._login()) {
    	_t._set("partyJoinlogin", 9);
        _joinBox._hide();
        _login4._show('tc_login');
        return false;
    }
    if (_hideMobile == "1") {
      $("#hide_verify_mobile").val("0");
      var _formYes = _joinForm._phone(_payItemId, _enrollOption, _nick, _mobile);
      if (!_formYes) {
        $("#hide_verify_mobile").val("1");
        return false;
      }
    } else {
      if (_joinForm._toVerifyMobile(_mobile)) {
        $("#hide_verify_mobile").val("1");
        _joinForm._next();
        return false;
      }
      _loading._show("加载中");
      _joinForm._dataPost(_payItemId, _enrollOption, _nick, _mobile);
    }
  },
  _dataPost: function(_payItemId, _enrollOption, _nick, _mobile) {
    if (_joinForm._price != 0) {
      _loading._hide();
      _joinBox._hide();
      _joinBeforeLogin._mark("");
      _backToRefresh._mark();
      _joinBox._clear();
      if (_joinForm._id == "party") {
        $("#hide_party_id").val(_info._id);
      } else {
        $("#hide_recruit_id").val(_info._id);
      }
      $("#hide_h_share_uid").val(_info._shareUid);
      $("#hide_pay_item_id").val(_payItemId);
      $("#hide_enroll_option").val(_enrollOption);
      $("#hide_big_name").val(_nick);
      $("#hide_mobile").val(_mobile);
    }
    _$(_api3._isPayOrder, "party_id=" + _info._id, _payItemBox._checkOk);
  },
  _ok: function(json, code) {
    _loading._hide();
    var _oid = "0";
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    if (code == 200) {
      _oid = json.pay.orderId;
      var _url = "/get/api:qr?user_id=" + _user._id() + "&info_id=" + _info._id + "&info_type=" + _info._type + "&qr_type=paySuccessCardQR";
      $("#orderId").val(_oid);
      $("#join_qr_img,#tc_2weima .weima2_2,#join_qr_img_2wm").attr("src", _url);
    }
    //不需支付
    if (_oid == "0") {
      //报名失败
      if (code != 200) {
        _toast._show("报名失败");
      } else {
        if(json.focus_state==true){
          $(".focus_Cz").html('<a id="attent_Btn" href="javascript:void(0)">已关注</a>');//报名成功自动关注,pc页面显示已关注
        }
        $("#dt_join_bar_title").html("<a onclick=\"_joinBar._show('party')\" href=\"javascript:void(0);\" class=\"xd_btn_r style02 party\"><img src=\" " + _info._img1Url + "/static_v4/images/detail/icon_man2.png\" alt=\"\" /><span>已报名</span></a>");
        $("div[name='detail_t_join']").html("<a href=\"javascript:void(0)\" class=\"style02\" onclick=\"_joinBar._show('party')\">已报名</a>");
        if ($("#join_total").attr("id") == undefined) {
          $("#dt_join_count").html("已有<span id=\"join_total\">1</span>人报名");
          $("#dt_list_main").show();
        } else {
          $("#join_total").html(parseInt($("#join_total").html()) + 1);
        }
        //pc详情页页面报名人数
        $("#detail_Joinnum .detail_Joinnum_t span").html(parseInt($("#detail_Joinnum span").html()) + 1);
        var _item = _joinLoading._addItem(json.user_join.join_user_id, json.user_join.big_name, json.user_join.user_pic, json.user_join.date, json.user_join.join_id);
        $("#dt_list_main").html(_item + $("#dt_list_main").html());
        if($("#join_loading a span").html()=="展开更多报名" && $("#dt_list_main li").length%10==1){
          $("#dt_list_main li").show().eq(-1).hide();
        }else{
          $("#dt_list_main li").show()
        }
        $("#dt_join_menu_bg .dt_join_top").unbind("click");
        _joinBeforeLogin._mark("");
        _joinBox._hide();
        _backToRefresh._mark();
        _joinBox._clear();
        _scroollTop._top(".dt_join_menu_bg", 500, 200);
        _joinAfter._show("tc_chengNopay");
        if (_info._verify == "0") {
          dataForShare.title = "我报名了《" + dataForShare.title + "》，你也来看看吧";
          if (_user._inWeixin()) {
            onBridgeReady_new();
          }
        }
        if (_joinForm._toVerifyMobile(_joinForm._mobile)) {
          _info._verifyMobile = _info._verifyMobile + _joinForm._mobile + "|";
        }
        if($(".tc_c_feiLi li").length!=0){
        	$(".tc_c_feiLi li").each(function(){
        		$(this).unbind("click");
            });
        }
        _payList._less();
      }
      $("#a_post").attr("href", "/post?hdb_from=PCEnroll" + _thisNext);
    } else { //需要支付
      if (code == 200) {
        _payItemBox._payOrderId = json.pay.orderId;
        _joinBox._hide();
        _joinBeforeLogin._mark("");
        _backToRefresh._mark();
        _joinBox._clear();
        $("#submit_ljB").attr("onclick", "_joinForm._closeOrder()");
//        _tc._show("payLock");
//        $(".detail_Joinnum_t p span").html(parseInt($('.detail_Joinnum_t p span').html()) + 1);
//        $("#submit_ljA,#submit_cxA,#dt_join_bar_title a,.detail_t_join a").attr({
//          "href": _link._alipay + "?order_id=" + _payItemBox._payOrderId,
//          'target': '_black'
//        });
//        $("#dt_join_bar_title a,.detail_t_join a").attr({
//          'onclick': '_joinForm._payAfter()'
//        });
//        $('#dt_join_bar_title a span,.detail_t_join a').text('去支付');
//        $("#dt_join_bar_title a,.detail_t_join a").css("background-color", "#9ab5e9");
//        var src = $('#dt_join_bar_title a img').attr('src').replace(/icon_man2.png/g, 'icon_pay.png');
//        $('#dt_join_bar_title a img').attr('src', src);
//      //报名成功后 对于当前未选中的票 移除点击事件
//        $(".tc_c_feiLi li").each(function(){
//        	$(this).unbind("click");
//        });
//        _payList._less();
        location.href = '/info_pay/'+_info._id + '?order_id=' + _payItemBox._payOrderId;
      }
      $("#a_post").attr("href", "/post?hdb_from=PCPay" + _thisNext);
    }
  },
  _phone: function(_payItemId, _enrollOption, _nick, _mobile) {
    var _inputCode = _._trim($("#rg2_form_yzm").val());
    if (_inputCode == "") {
      $("#rg2_form_yzm").focus();
      _toast._show("请输入验证码");
      return false;
    }
    if (_getCode._code != _inputCode) {
      _toast._show("验证码不正确，请重试");
      return false;
    }
    _loading._show("加载中");
    var _flag = _$asyn(_detailApi3._verifyCode, "verify_code=" + _inputCode + "&mobile=" + _mobile, _joinForm._phoneOk);
    if (!_flag) {
      return false;
    }
    _phoneBox._hide();
    _joinForm._dataPost(_payItemId, _enrollOption, _nick, _mobile);
    return true;
  },
  _phoneOk: function(json, code) {
    _loading._hide();
    if (json.state.toString() != "0") {
      _toast._show(json.error, function() {
        _user._error(json.state, "verify_code");
      });
      return;
    }
  },
  _checkProperty: function() {
    var _re = false;
    var _toastArr = ["请报上你的大名", "请输入你的手机号", "请输入你所在的单位", "请输入你的职位", "请输入你所在的行业", "备注请在50个字以内"];
    var _lenArr = [20, 0, 40, 20, 20, 100, 400];
    var _lenToastArr = ["大名请少于10字", "手机号不正确", "单位名称请少于20字", "职位名称请少于10字", "行业信息请少于10字", "备注请少于50字", "请少于200字"];
    $("#ul_join_property li").each(function() {
      var inputType = $(this).attr("type");
      if ("danH" == inputType) {
        var _propertyId = $(this).find("input").attr("propertyid");
        var _value = _._trim($(this).find("input").val());
        if (_value == "") {
          if (_propertyId <= 5) {
            _toast._show(_toastArr[_propertyId - 1]);
            $(this).focus();
            _re = true;
            return false;
          } else if (_propertyId > 6) {
            var _name = $(this).find(".optionsName").text();
            _toast._show("请输入你的" + _name);
            $(this).focus();
            _re = true;
            return false;
          }
        } else {
          if (_value.match(/\^|\|/) != null) {
            _toast._show("不能包含特殊字符");
            $(this).focus();
            _re = true;
            return false;
          }
          if (_propertyId == 2) {
            //手机验证
            if (_joinForm._toVerifyMobile(_value)) {
              if (_value.match(/^((1\d{10})|((0\d{2,3}[ -]?)?\d{7,8})|(\+\d{2,3}\d+))$/) == null) {
                _toast._show("手机号不正确");
                $(this).focus();
                _re = true;
                return false;
              }
            } else {
              if (_value.match(/^((1\d{10})|((0\d{2,3}[ -]?)?\d{7,8})|(\+\d{2,3}\d+))$/) == null) {
                _toast._show("手机号不正确");
                $(this).focus();
                _re = true;
                return false;
              }
            }
          } else {
            var _len = _._len(_value);
            if (_propertyId <= 6) {
              if (_len > _lenArr[_propertyId - 1]) {
                _toast._show(_lenToastArr[_propertyId - 1]);
                $(this).focus();
                _re = true;
                return false;
              }
            } else {
              if (_len > _lenArr[6]) {
                var _name = $(this).attr("placeholder");
                _toast._show(_name + _lenToastArr[6]);
                $(this).focus();
                _re = true;
                return false;
              }
            }
          }
        }
      } else if ("duoH" == inputType) {
        var _propertyId = $(this).find("textarea").attr("propertyid");
        var _value = _._trim($(this).find("textarea").val());
        if (_value == "") {
          var _name = $(this).find(".optionsName").text();
          _toast._show("请输入你的" + _name);
          $(this).find("textarea").focus();
          _re = true;
          return false;
        }
      } else if ("danX" == inputType) {
        var num = 0;
        $(this).find(".danXzu").find(".thisOver").each(function() {
          num++;
        });
        if (num == 0) {
          var _name = $(this).find(".optionsName").text();
          _toast._show("请选择：" + _name);
          _re = true;
          return false;
        }
      } else if ("duoX" == inputType) {
        var num = 0;
        $(this).find(".duoXzu").find(".thisOver").each(function() {
          num++;
        });
        if (num == 0) {
          var _name = $(this).find(".optionsName").text();
          _toast._show("请选择：" + _name);
          _re = true;
          return false;
        }
      }
    });
    return _re;
  },
  _getPorpertyValue: function() {
    var _proValue = "";
    $("#ul_join_property li").each(function() {
      if ($(this).attr("type") == 'danH') {
        _proValue += $(this).find("input").attr("propertyid") + "|" + $(this).find("input").val() + "^";
      } else if ($(this).attr("type") == 'duoH') {
        _proValue += $(this).find("textarea").attr("propertyid") + "|" + $(this).find("textarea").val() + "^";
      } else if ($(this).attr("type") == 'danX') {
        var idStr = $(this).attr("propertyid");
        var valueStr = "";
        $(this).find(".thisOver").each(function() {
          valueStr += $(this).attr("id") + ",";
        });
        _proValue += idStr + "|" + valueStr + "^";
      } else if ($(this).attr("type") == 'duoX') {
        var idStr = $(this).attr("propertyid");
        var valueStr = "";
        $(this).find(".thisOver").each(function() {
          valueStr += $(this).attr("id") + ",";
        });
        _proValue += idStr + "|" + valueStr + "^";
      }
    });
    return _proValue;
  },
  _init: function(id) {
    _joinForm._id = id;
    _payItemBox._check_ispay2();
  },
  _next: function() {
    _joinBox._hide();
//    if (_joinForm._price != 0) {
//      $("#input_submit_phone").show();
//      $("#a_submit_phone").hide();
//    } else {
//      $("#a_submit_phone").show();
//      $("#input_submit_phone").hide();
//    }
  $("#a_submit_phone").show();
  $("#input_submit_phone").hide();
    _phoneBox._show();
  },
  _payAfter: function() {
    _tc._hide("payLock");
    _tc._show("tc_payQuestion");
  },
  _closeOrder: function() {
    $("#submit_ljB").attr("onclick", "");
    _$(_api3._cancelOrder, "party_id=" + _info._id, _joinForm._closeOrderOk);
  },
  _closeOrderOk: function(json, code) {
    _loading._hide();
    if (code != 200) {
      return;
    }
    if (json.is_cencal.toString() != "1") {
      _tc._hide("payLock");
      _toast._show("取消报名失败");
    } else {
      _tc._hide("payLock");
      _toast._show("取消成功");
      $("#dt_join_bar_title a,.detail_t_join a").attr({
        "href": 'javascript:;',
        'target': '_self',
        'onclick': '_payItemBox._next()'
      });
      $('#dt_join_bar_title a span,.detail_t_join a').text('我要报名');
      $("#dt_join_bar_title a,.detail_t_join a").css("background-color", "#0099e9");
      var src = $('#dt_join_bar_title a img').attr('src').replace(/icon_pay.png/g, 'icon_man2.png');
      $('#dt_join_bar_title a img').attr('src', src);
      $(".tc_c_feiLi li").each(function(){
        $(this).bind("click", function(){
          $(this).addClass('select').siblings('li').removeClass('select');
        });
      });
      _payList._add();
    }
    $(".detail_Joinnum_t p span").html(parseInt($('.detail_Joinnum_t p span').html()) - 1);
  }
};

/* TODO 自定义项*/
var _joinBox = {
  _ie: true,
  _id: "",
  _currentTop: 0,
  _iosSet: function() {
    var y = $(window).height();
    _joinBox._currentTop = $(document).scrollTop();
    document.body.scrollTop = 0;
    $("body").css({
      "height": y + _joinBox._currentTop + "px",
      "overflow": "hidden"
    });
    $("#cover2").height(y);
  },
  _initProperty: function() {
    $("#ul_join_property input").each(function() {
      var _value = _payItemBox._getTemp(_joinBox._id + "_pay_item_id_" + $(this).attr("propertyid"));
      if (_value != "") {
        $(this).val(_value);
      }
    });
  },
  _show: function(id) {
	_tc._show("join_box");
    $("#ul_join_property li").removeClass("thisOver");
  },
  _hide: function() {
	_tc._hide("join_box");
    _t._set("login_Way", 0);
  },
  _clear: function() {
    _payItemBox._setTemp(_joinBox._id + "_pay_item_id", "");
    _payItemBox._setTemp(_joinBox._id + "_agree", "");
    $("#ul_join_property input").each(function() {
      _payItemBox._setTemp(_joinBox._id + "_pay_item_id_" + $(this).attr("propertyid"), "");
    });
  }
};
/** TODO 支付项*/
var _payItemBox = {
  _id: "",
  _payOrderId: "",
  _isJoinParty: "",
  _payItemId : "",
  _setAgree: function(obj) {
    if (obj.attr("class") == "thisOver") {
      obj.parent().next("div").children("a").eq(0).show().siblings().hide();
      _payItemBox._setTemp(_payItemBox._id + "_agree", "1");
    } else {
      obj.parent().next("div").children("a").eq(1).show().siblings().hide();
      _payItemBox._setTemp(_payItemBox._id + "_agree", "0");
    }
  },
  _setTemp: function(key, value) {
    _t._set(key + "_" + _info._id + "_" + _info._type, value);
  },
  _getTemp: function(key) {
    return _t._get(key + "_" + _info._id + "_" + _info._type);
  },
  _show: function(id) {
    _payItemBox._id = id;
    if($(".tc_c_feiLi li").length==1){
    	$(".tc_c_feiLi li").attr("class","select");
    }
    _payItemBox._next();
  },
  _next: function() {
    var _payLen = $(".tc_c_feiLi li[class='select']").length;
    if(_info._isPay == "1" && _payLen == 0){
        _toast._show("请先选择收费项");
        $(document).scrollTop(210);
        return;
    }
    var _price = 0;
    if (_payLen > 0) {
      _price = /\d*(\.)?\d*/.exec($(".tc_c_feiLi li[class='select'] .ticket_money").html())[0];
    }
    _joinBox._show(_payItemBox._id);
  },
  _check_ispay: function() {
    _t._set("login_Way", 7);
    if (!_user._login()) {
      _login4._show('tc_login');
      return;
    }
   var param = "party_id=" + _info._id;
   if(_info._isPay == "1"){
       var _payItemId = "";
       if ($(".tc_c_feiLi li[class='select']").length > 0) {
           _payItemId = $(".tc_c_feiLi li[class='select']").attr("payitemid");
       }
       if(_payItemId == ""){
           _toast._show("请先选择收费项");
           $(document).scrollTop(210);
       }
        param += "&pay_item_id=" + _payItemId;
   }
    _$(_api3._isPayOrder, param, _payItemBox._checkOk);
  },
  _check_ispay2: function() {
    if (!_user._login()) {
      return false;
    }
    _$(_api3._isPayOrder, "party_id=" + _info._id, _payItemBox._checkOk2);
  },
  _checkOk: function(json, code) {
    if (code != 200) {
      return;
    }
    _payItemBox._payOrderId = json.payOrder_id;
    _payItemBox._isJoinParty = json.isjoinparty;
    _payItemBox._payItemId = json.item_id;
    if (json.prderstate == "2") {
      $(".tc_c_feiLi li").each(function(){
          if($(this).attr("payitemid") == _payItemBox._payItemId){
              $(this).addClass("select");
          }else{
              $(this).removeClass("select");
          }
      });
      $("#submit_ljB").attr("onclick", "_joinForm._closeOrder()");
//      _tc._show("payLock");
//      _payList._less();
//      $("#orderId").val(json.payOrder_id);
//      $("#submit_ljA,#submit_cxA,#dt_join_bar_title a,.detail_t_join a").attr({
//        "href": _link._alipay + "?order_id=" + _payItemBox._payOrderId,
//        "target": "_blank",
//        "onclick": "_joinForm._payAfter()"
//      });
//      var src = $('#dt_join_bar_title a img').attr('src').replace(/icon_man2.png/g, 'icon_pay.png');
//      $('#dt_join_bar_title a img').attr('src', src);
//      $('#dt_join_bar_title a span,.detail_t_join a').text('去支付');
//      $("#dt_join_bar_title a,.detail_t_join a").css("background-color", "#0099e9");
      location.href = '/info_pay/'+_info._id + '?order_id=' + _payItemBox._payOrderId;
    } else {
      if (_payItemBox._isJoinParty == 1) {
        _loading._hide();
        _toast._show("此活动您已经报过名");
        $("#dt_join_bar_title a").attr({
          "class": "xd_btn_r style02",
          "onclick": "_joinBar._show('party')"
        });
        $(".detail_t_join a").attr({
          "class": "style02",
          "onclick": "_joinBar._show('party')"
        });
        $("#dt_join_bar_title a span,.detail_t_join a").text("已报名");
      } else if (_payItemBox._isJoinParty == 2) {
        var _thisNext = _info._type.replace(_info._type, function($1) {
          return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
        });
        var _hideMobile = $("#hide_verify_mobile").val();
        var _payItemId = "";
        if ($(".tc_c_feiLi li[class='select']").length > 0) {
          _payItemId = $(".tc_c_feiLi li[class='select']").attr("payitemid");
        }
        if (_joinForm._checkProperty()) {
          return false;
        }
        var _mobile = "";
        if ($("#input_pro_id_2").attr("id") != undefined) {
          _mobile = _._trim($("#input_pro_id_2").val());
          _joinForm._mobile = _mobile;
        }
        var _enrollOption = _joinForm._getPorpertyValue();
        var _nick = _._trim($("#input_pro_id_1").val());
        if (_joinForm._id == "party") {
          _$(_api3._joinParty, "h_share_uid=" + _info._shareUid + "&party_id=" + _info._id + "&pay_item_id=" + _payItemId + "&enroll_option=" + _._encode(_enrollOption) + "&big_name=" + _._encode(_nick) + "&mobile=" + _._encode(_mobile), _joinForm._ok);
        } else {
          _$(_api3._joinRecruit, "h_share_uid=" + _info._shareUid + "&recruit_id=" + _info._id + "&pay_item_id=" + _payItemId + "&enroll_option=" + _._encode(_enrollOption) + "&big_name=" + _._encode(_nick) + "&mobile=" + _._encode(_mobile), _joinForm._ok);
        }
      }
    }
  },
  _checkOk2: function(json, code) {
    if (code != 200) {
      return;
    }
    _payItemBox._payOrderId = json.payOrder_id;
    _payItemBox._payItemId = json.item_id;
    if (json.prderstate == "2") { //未锁定
      //页面初始化时 勾选用户已选的收费项 -  TODO 此处需要让其他票 不能点
      $(".tc_c_feiLi li").each(function(){
          if($(this).attr("payitemid") == _payItemBox._payItemId){
              $(this).addClass("select");
              $(this).unbind("click");
          }else{
              $(this).removeClass("select");
              $(this).unbind("click");
          }
      });
      $("#submit_ljB").attr("onclick", "_joinForm._closeOrder()");
      $("#orderId").val(json.payOrder_id);
      var _oid = json.payOrder_id;
      $("#dt_join_bar_title a,.detail_t_join a").attr({
        //"href": _link._alipay + "?order_id=" + _payItemBox._payOrderId,
    	"href": '/info_pay/'+_info._id + '?order_id=' + _payItemBox._payOrderId,
//        'target': '_black',
        'onclick': ''
      });
      var src = $('#dt_join_bar_title a img').attr('src').replace(/icon_man2.png/g, 'icon_pay.png');
      $('#dt_join_bar_title a img').attr('src', src);
      $('#dt_join_bar_title a span,.detail_t_join a').text('去支付');
      $("#dt_join_bar_title a,.detail_t_join a").css("background-color", "#9ab5e9");
    } else {
      setTimeout(function() {
        _joinBeforeLogin._continue();
      }, 500);
    }
  }
};

/**手机验证*/
var _phoneBox = {
  _currentTop: 0,
  _show: function() {
    $(".join_box_ph p span").text($("#input_pro_id_2").val());
    $("#rg2_form_yzm").val("");
    _tc._show("join_box_ph");
    _getCode._post();
    $("#cover2").attr("onclick","_phoneBox._full()");
  },
  _hide: function() {
    _getCode._count = 60;
    $("#hide_verify_mobile").val("0");
    $("#rg2_form_yzm").val("");
    _tc._hide("join_box_ph");
  },
  _full: function() {
	_getCode._count = 60;
	$("#hide_verify_mobile").val("0");
	$("#rg2_form_yzm").val("");
  }
};
var _getCode = {
  _count: 60,
  _code: "",
  _getTimer: null,
  _countDown: function() {
    $(".huoYzm_btn").attr("onclick", "");
    $(".huoYzm_btn").css({
      "background-color": "#dbdbdb",
      "color": "#999999"
    });
    _getCode._getTimer = setInterval(function() {
      if (_getCode._count == 1) {
        _getCode._clear();
        return;
      }
      _getCode._count--;
      $(".huoYzm_btn").text(_getCode._count + "s");
    }, 1000);
  },
  _clear: function() {
    $(".huoYzm_btn").unbind("click");
    $(".huoYzm_btn").attr("onclick", "").click(eval(function() {
      _getCode._post();
    }));
    $(".huoYzm_btn").css({
      "background-color": "#0099e9",
      "color": "#FFFFFF"
    });
    $(".huoYzm_btn").text("重发");
    clearInterval(_getCode._getTimer);
    _getCode._count = 60;
  },
  _post: function() {
    var _phone = $("#join_box_ph p span").text();
    if (!_phone.match(/^1\d{10}$/)) {
      return;
    }
    _loading._show("请稍候");
    _$(_detailApi3._sendCode, "mobile=" + _phone, _getCode._ok);
  },
  _ok: function(json, code) {
    _loading._hide();
    if (code != 200) {
      return;
    }
    _getCode._code = json.validation_code;
    $(".huoYzm_btn").unbind("click");
    _getCode._countDown();
    _toast._show("校验码已发送");
  }
};

/**分享图标的显示*/
var _share = {
  _init: function() {
    if (_user._inWeibo()) {
      $("#share_weixin_guide").attr("src", _imgCdn + "/images/guide_weibo.png?new");
      $("#div_weibo").show();
    } else if (_user._inWeixin()) {
      $("#share_weixin_guide").attr("src", _imgCdn + "/images/guide_weixin.png?new");
    } else if (_user._inQq()) {
      $("#share_qq_guide").attr("src", _imgCdn + "/images/guide_qq.png?new");
      $("#div_qq").show();
    } else if (_user._inHudongba() || _user._inMobile()) {
      $("#div_no_pc").show();
    } else {
      $("#div_pc").show();
    }
    if (!_user._inWeixin()) {
      $("#info_share").css({
        "color": "#0099e9"
      });
    } else {
      $("#info_share").css({
        "color": "#666"
      });
      $("#info_share").attr("onclick", "");
    }
  },
  _toFriend: function() {
    _toast._show("请点击菜单上的分享图标进行发送");
  },
  _joinSucess: function() {
    if (!_user._inMobile()) {
      _qr._show("share_qr");
    } else if (_user._inWeixin() || _user._inWeibo()) {
      _shareInWeixin._show();
    } else if (_user._inQq()) {
      _shareInQq._show();
    } else {
      _share._toFriend();
    }
    if (_postSucess._fromApp()) {
      setTimeout(function() {
        $(".inviteZu").css({
          "background-color": "#e5e5e5",
          "-webkit-transition": "background-color 0.3s linear",
          "-moz-transition": "background-color 0.3s linear"
        });
        setTimeout(function() {
          $(".inviteZu").css({
            "background-color": "#FFFFFF",
            "-webkit-transition": "background-color 0.3s linear",
            "-moz-transition": "background-color 0.3s linear"
          });
        }, 800);
      }, 200);
    }
  }
};
/*发布成功**/
var _postSucess = {
  _fromApp: function() {
    return _user._inHudongba() && location.href.toString().indexOf("current=postsucess") != -1;
  },
  _fromPCPreview: function() {
    return location.href.toString().indexOf("view=1") != -1;
  },
  _fromWeb: function() {
    return document.referrer.indexOf("/post") != -1 && document.referrer.indexOf("/manage/post") == -1;
  },
  _modify: function() {
    if (_user._inHudongba()) {
      HudongbaJsBridge["getModifyPage"](_info._id, _info._type, _info._title);
    } else {
      if (!window.localStorage) {
        _alert._show("浏览器版本过低", "请登录互动吧App后再进行操作", "一键安装App", function() {
          _download(_link._appDownload);
        }, "关闭提示");
        return;
      }
      //var _refer = document.referrer;
      //_refer = _refer.indexOf("?") != -1 ? _refer.split("?")[0] : _refer;
      var _refer = "/post/" + _info._type;
      _g(_refer + "?id=" + _info._id);
    }
  },
  _init: function() {
    if (_postSucess._fromApp()) {
      $("#dt_join_bar").hide();
      $(".dt_share").hide();
      $(".dt_post_sucess").show();
      $("#div_share_type").show();
      $("#dt_guess").hide();
      $("#dt_carte").hide();
      $(".userPicA,.subinfo_name").attr("href", "javascript:void(0)");
      return;
    }
    if (_postSucess._fromWeb()) {
      $(".dt_post_sucess").show();
    }
    $("#dt_join_bar").show();
    $("#dt_join_bar").css({
      "bottom": -57 + "px"
    });
    $("#dt_join_bar").animate({
      "bottom": 0 + "px"
    }, "slow");
    var p = $(".detail_Time_t p").html();
    if (p == " " || p == "&nbsp;") {
      $(".detail_Time_b").css({
        "padding-left": 0,
        "margin-left": -5 + "px"
      });
    }
  },
  _showWin: function(type) {
    if (type == "qr") {
      _qr._show("share_qr_1");
      return;
    }
    HudongbaJsBridge["shareType"](type);
  }
};

/**评论、参与、猜你喜欢loading*/
var _bottomLoading = {
  _end: function(id, text) {
    $("#" + id).html("<span class=\"upAll font03\">" + text + "</span>");
    $("#" + id).unbind("click");
    $("#" + id).show();
  },
  _loading: function(id, text) {
    $("#" + id).html("<span class=\"upding font03\"><img src=\"" + _imgCdn + "/images3/loading2.gif\">" + text + "</span>");
    $("#" + id).unbind("click");
    $("#" + id).show();
  },
  _more: function(id, text, fun) {
    $("#" + id).html("<a class=\"moreBtn font03\"><span>" + text + "</span></a>");
    $("#" + id).bind("click", fun);
    $("#" + id).show();
  },
  _hide: function(id) {
    $("#" + id).hide();
  }
};

/**评论前判断*/
var _reviewBeforeLogin = {
  _mark: function(value) {
    _t._set("review_before_login_" + _info._type + "_" + _info._id, value);
  },
  _continue: function() {
    if (_t._get("review_before_login_" + _info._type + "_" + _info._id) != "") {
      setTimeout(function() {
        _reviewBeforeLogin._post();
        _review._post();
      }, 500);
    }
  },
  _setTemp: function(key, value) {
    _t._set(key + "_" + _info._type + "_" + _info._id, value);
  },
  _getTemp: function(key) {
    return _t._get(key + "_" + _info._type + "_" + _info._id);
  },
  _post: function() {
    _review._replyUid = _reviewBeforeLogin._getTemp("review_replyUid");
    _review._questionId = _reviewBeforeLogin._getTemp("review_questionId");
    $("#dt_review_form_content").attr("placeholder", "继续评论/回复：");
    _reviewBox._show();
  }
};

var _backToRefresh = {
  _mark: function() {
    _t._set("join_sucess", "/" + _info._type + "/" + _info._id);
  },
  _should: function() {
    return _t._get("join_sucess") != "" && document.referrer != "" && document.location.href.indexOf(_t._get("join_sucess")) != -1;
  },
  _clear: function() {
    _t._set("join_sucess", "");
  }
};

/**评论*/
var _review = {
  _replyUid: "0",
  _pId: "0",
  _isRootDiscuss: true,
  _kboot:"0",
  _post: function() {
    _t._set("login_Way", 2);
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    var _content = _emo._toCode(_._trim($("#dt_review_form_content").val()));
    if (_content == "") {
      _toast._show("请输入评论");
      return;
    }
    if (_._len(_content) > 200) {
      _toast._show("评论请在100字以内");
      return;
    }
    if (!_user._login()) {
      _reviewBeforeLogin._mark("1");
      _login4._show('tc_login');
      return;
    }
    _loading._show("请稍候");
    _review._isRootDiscuss = true;
    _review._kboot = "1";
    _$(_api3._review, "h_share_uid=" + _info._shareUid + "&info_id=" + _info._id + "&info_type=" + _info._type + "&content=" + _._encode(_content), _review._ok);
  },
  _post2: function() {
    _t._set("login_Way", 3);
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    var _content = _._trim($("#dt_review_form_content2").val());
    if (_content == "") {
    	_toast._show("请输入评论");
      return;
    }
    if (_._len(_content) > 200) {
      _toast._show("评论请在100字以内");
      return;
    }
    if (!_user._login()) {
      _reviewBeforeLogin._mark("1");
      _login4._show('tc_login');
      return;
    }
    _loading._show("请稍候");
    _review._isRootDiscuss = false;
    _review._kboot = "2";
    _$(_api3._review, "h_share_uid=" + _info._shareUid + "&pId=" + _review._pId + "&info_id=" + _info._id + "&info_type=" + _info._type + "&replyUserid=" + _review._replyUid + "&content=" + _._encode(_content), _review._ok);
  },
  _ok: function(json, code) {
    _loading._hide();
    if (json.state.toString() != "0") {
      _toast._show(json.error, function() {
        _user._error(json.state, "review");
      });
      return;
    }
    var _data = json.discuss_info;
    var _pId = _data.pId;
    var _item = _review._itemDom(_data.id, _pId, _data.userId, _data.userName, _data.replyUserId, _data.replyUserName, _data.date, _data.discussContent, _data.user_pic, _data.nick_name);

    if (_review._kboot == "1") {
      if($("#dt_review_form_content2").length!=0){
    	  var lsTit = $("#dt_review_form_content2").val();
      }
      $("#dt_review_main").prepend(_item);
      $("#dt_review_main").show();
      $("#dt_review_form_content").val("");
      $(".dt_review_edit_r a").attr("class","dt_review_post_A");
      if($("#dt_review_form_content2").length!=0){
    	  $("#dt_review_form_content2").val(lsTit);
      }
    } else if (_review._kboot == "2"){
      $("#dt_review_box2").parent().after(_item); //添加评论
      $("#dt_review_box2").remove(); //移除输入框
    }
    var _total = 1;
    if ($("#review_total").attr("id") != undefined) {
      _total = parseInt($("#review_total").html()) + 1;
    }
    $("#dt_review_count").html("<span id=\"review_total\">" + _total + "</span>条评论");
    if (_info._type == "job") {
      $("#dt_review_count").html("<span id=\"review_total\">" + _total + "</span>条留言");
    }
    _review._reset();
    if (_postSucess._fromApp()) {
      $("#dt_review_item_" + _data.id + " a").attr("href", "javascript:void(0)");
    }
    
    _reviewBox._setTemp("review_content", "");
    _reviewBeforeLogin._setTemp("review_replyUid", "");
    _reviewBeforeLogin._mark("");
    _backToRefresh._mark();
    _reviewBox._hide();
  },
  _okFromApp: function(json) {
    _review._ok(json, 200);
  },
  _itemDom: function(id, pId, userId, userName, replyUserId, replyUserName, date, discussContent, userImg, nick_name) {
    //**敏感字校验**
    if (!verifyWord(userName)) {
      userName = '互动吧用户';
    }
    if (!verifyWord(replyUserName)) {
      replyUserName = '互动吧用户';
    }
    if (!verifyWord(nick_name)) {
      nick_name = "互动吧用户";
    }
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    var _item = "<li id=\"dt_review_item_" + id + "\" class=\"dt_review_main_li\ " + (replyUserId != "0" ? "dt_review_repeat" : "") + "\">" + "<div class=\"dt_review_icon\"><a target=\"_blank\" " + " href=\"/timeline/" + userId + "?hdb_from=" + _khDuan._duanId + _thisNext + "Comment\">";
    if (userImg == "") {
      _item += "<img class=\"default_img\" src=\"" + _imgCdn + "/static_v4/images/other/face_default_200.png\">";
    } else {
      _item += "<img class=\"default_img\"  src=\"" + userImg + "\" onerror=\"this.src='" + _imgCdn + "/static_v4/images/other/face_default_200.png'\">";
    }
    _item += "</a></div>";
    _item += "<div class=\"dt_review_R\"><div class=\"dt_review_body\">" + "<div class=\"dt_review_title dt_loadNew\"><a target=\"_blank\" " + " href=\"/timeline/" + userId + "?hdb_from=" + _khDuan._duanId + _thisNext + "Comment\">" + userName + "</a></div>";

    if (replyUserId != "0") {
      _item += "回复<a  href=\"/timeline/" + replyUserId + "?hdb_from=" + _khDuan._duanId + _thisNext + "Comment\">" + replyUserName + "</a>";
    }
    _item += "：" + discussContent + "</div><div class=\"dt_review_B\"><p class=\"dt_review_time\">" + date + "</p><a class=\"dt_review_re_icon\" title=\"回复\" onclick=\"_reviewBox._rePost2('" + userId + "','" + userName + "','" + nick_name + "','dt_review_item_" + id + "','" + pId + "')\">" + "</a></div></div></li>";
    return _item;
  },
  _reset: function() {
    _reviewLoading._delParent();
  }
};
/**评论框*/
var _reviewBox = {
  _currentTop: 0,
  _iosSet: function() {
    var y = $(window).height();
    _reviewBox._currentTop = $(document).scrollTop();
    document.body.scrollTop = 0;
    $("body").css({
      "height": y + _reviewBox._currentTop + "px",
      "overflow": "hidden",
      "margin-top": -_reviewBox._currentTop + "px"
    });
    $("#cover2").height(y);
  },
  _show: function(uName, nick) {
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    if (!_user._login() && !window.localStorage) {
      _user._toLogin(_thisNext);
      return;
    }
    _reviewBox._inputed();
    $("#dt_review_form_content").focus();
    $("#dt_review_form_content").val(_reviewBox._getTemp("review_content"));
  },
  _hide: function() {
    $("body").css({
      "height": "auto",
      "overflow": "auto"
    });
  },
  _post: function() {
    _review._replyUid = 0;
    var _reviewFrom = $("#dt_review_form_content")[0];
    _reviewFrom.setAttribute("placeholder", "评论：");
    if (_info._type == "job") {
      _reviewFrom.setAttribute("placeholder", "留言：");
    }
    _reviewBox._show();
  },
  _rePost: function(uId, uName, nick) {
    _review._replyUid = uId;
    var _reviewFrom = $("#dt_review_form_content")[0];
    _reviewFrom.setAttribute("placeholder", "回复" + uName + "：");
    _reviewBox._show(uName, nick);
  },
  _focus: function() {
    _emo._hide("dt_review_box_emo");
    with($("#dt_review_form_content")) {
      var _value = $("#dt_review_form_content").val();
      $("#dt_review_form_content").val("");
      $("#dt_review_form_content").val(_value);
    }
  },
  _blur: function() {
    _reviewBox._setTemp("review_content", $("#dt_review_form_content").val());
    _reviewBeforeLogin._setTemp("review_replyUid", _review._replyUid);
  },
  _inputed: function() {
    $("#dt_review_form_post").attr("class", _._trim($("#dt_review_form_content").val()) == "" ? "button_1_disabled" : "button_1");
  },
  _setTemp: function(key, value) {
    _t._set(key + "_" + _info._type + "_" + _info._id + "_" + _review._replyUid, value);
  },
  _getTemp: function(key) {
    return _t._get(key + "_" + _info._type + "_" + _info._id + "_" + _review._replyUid);
  },
  _showEmo: function() {
    _emo._show("dt_review_box_emo", function(index) {
      $("#dt_review_form_content").val($("#dt_review_form_content").val() + _emo._text[index]);
      _reviewBox._inputed();
      _reviewBox._blur();
    });
  },
  _rePost2: function(uId, uName, nick, item_id, pId) {
    var _html = "<div id=\"dt_review_box2\"><div id=\"dt_review_box_input2\"><p><textarea id=\"dt_review_form_content2\" name=\"\" cols=\"\" rows=\"\" oncut=\"_reviewText._input2()\" onpropertychange=\"_reviewText._input2()\" oninput=\"_reviewText._input2()\" onpaste=\"_reviewText._input2()\" placeholder=\"回复" + uName + "：\"></textarea></p></div><button onclick=\"_review._post2()\" class=\"button_1_disabled\" id=\"dt_review_form_post2\">回复</button></div>";
    _review._replyUid = uId;
    _review._pId = pId;
    if ($("#" + item_id).children("#dt_review_box2").size() == 0) {
      $("#" + item_id).append(_html);
    }
    $("#" + item_id).siblings("li").children("#dt_review_box2").remove();
    $("#dt_review_form_content2").keyup(function (){
  	  if($(this).val()!=""){
  		  $("#dt_review_form_post2").attr("class","button_1_disabled able");
  	  }else{
  		  $("#dt_review_form_post2").attr("class","button_1_disabled");
  	  }
    });
  }
};

/**评论列表*/
var _reviewLoading = {
  _total: 0,
  _nowTime: 0,
  _index: 1,
  _flag: false,
  _init: function() {
    _reviewBeforeLogin._continue();
    _reviewLoading._post();
  },
  _post: function() {
    if (_reviewLoading._flag == true) {
      return;
    }
    _reviewLoading._flag = true;
    _bottomLoading._loading("review_loading", "正在加载...");
    _$(_api3._reviewList, "info_id=" + _info._id + "&info_type=" + _info._type + "&page_num=" + _reviewLoading._index + "&now_time=" + _reviewLoading._nowTime + "&count=" + _reviewLoading._total, _reviewLoading._ok);
  },
  _ok: function(json, code) {
    _bottomLoading._hide("review_loading");
    var _state = json.state;
    if (code != 200 || (code == 200 && _state != "0")) {
      _bottomLoading._more("review_loading", "网络错误，点击重新加载", _reviewLoading._post);
      return;
    }
    var _data = json.discussArray,
      _len = _data.length;
    _reviewLoading._nowTime = json.nowTime;
    if (_reviewLoading._index == 1) {
      _reviewLoading._total = json.total;
      if (json.total == "0") {
        $("#dt_review_count").html("快来发表你的评论");
        if (_info._type == "job") {
          $("#dt_review_count").html("快来发送留言");
        }
      } else {
        $("#dt_review_count").html("<span id=\"review_total\">" + json.total + "</span>条评论");
        if (_info._type == "job") {
          $("#dt_review_count").html("<span id=\"review_total\">" + json.total + "</span>人留言");
        }
      }
    }
    if (_len == 0) {
      return;
    }
    if (json.nextState.toString() == "1") {
      _reviewLoading._flag = false;
      _reviewLoading._index++;
      if (_info._type == "job") {
        _bottomLoading._more("review_loading", "展开更多留言", _reviewLoading._post);
      } else {
        _bottomLoading._more("review_loading", "展开更多评论", _reviewLoading._post);
      }
    }
    var _html = "";
    for (var i = 0; i < _len; i++) {
      var _item = _review._itemDom(_data[i].discussId, _data[i].pId, _data[i].userId, _data[i].nickName, _data[i].replyUserId, _data[i].replyNickName, _data[i].date, _data[i].discussContent, _data[i].userPic, _data[i].nick_name);
      _html += _item;
    }
    $("#dt_review_main").html($("#dt_review_main").html() + _html);
    $("#dt_review_main").show();
    _review._reset();
  },
  _delParent: function() {
    $("#dt_review_main .dt_review_icon a,#dt_review_main .dt_review_title").bind("click", function(event) {
      event.stopPropagation();
    });
  }
};

/**参与列表*/
var _joinLoading = {
  _total: 0,
  _nowTime: 0,
  _index: 1,
  _flag: false,
  _init: function() {
    _joinLoading._post();
  },
  _post: function() {
    if (_joinLoading._flag == true) {
      return;
    }
    _joinLoading._flag = true;
    _bottomLoading._loading("join_loading", "正在加载...");
    _$(_api3._joinList, "info_id=" + _info._id + "&info_type=" + _info._type + "&page_num=" + _joinLoading._index + "&now_time=" + _joinLoading._nowTime + "&count=" + _joinLoading._total, _joinLoading._ok);
  },
  _post2: function() {
    _bottomLoading._loading("join_loading", "正在加载...");
    _$(_api3._joinList, "info_id=" + _info._id + "&info_type=" + _info._type + "&page_num=" + _joinLoading._index + "&now_time=" + _joinLoading._nowTime + "&count=" + _joinLoading._total, _joinLoading._ok);
  },
  _ok: function(json, code) {
    _bottomLoading._hide("join_loading");
    var _state = json.state;
    if (code != 200 || (code == 200 && _state != "0")) {
      _bottomLoading._more("join_loading", "网络错误，点击重新加载", _joinLoading._post);
      return;
    }
    var _data = json.enrollArray,
      _len = _data.length;
    _joinLoading._nowTime = json.nowTime;
    if (_joinLoading._index == 1) {
      var total_html = "<span id=\"join_total\">" + json.total + "</span>人已完成报名";
      var pay_html = json.ispay_count + "人正在支付";
      var d_html = "快来报名参加";
      if (json.ispay_count > 0) {
        total_html += "，" + pay_html;
        d_html = pay_html;
      }
      _joinLoading._total = json.total;
      if (json.total == "0") {
        $("#dt_join_count").html(d_html);
//        $("#dt_join_menu_bg .dt_join_top").bind("click", function() {
//          _payItemBox._show(_info._type);
//        });
      } else {
        $("#dt_join_count").html(total_html);
      }
    }
    if (_len == 0) {
      return;
    }
    if (json.nextState.toString() == "1") {
      _joinLoading._flag = false;
      _joinLoading._index++;
      _bottomLoading._more("join_loading", "展开更多报名", _joinLoading._post);
    }
    var _html = "";
    for (var i = 0; i < _len; i++) {
      var _item = _joinLoading._addItem(_data[i].userId, _data[i].bigName, _data[i].userPic, _data[i].date, _data[i].joinId);
      _html += _item;
    }
    $("#dt_list_main").html($("#dt_list_main").html() + _html);
    if($("#join_loading a span").html()=="展开更多报名" && $("#dt_list_main li").length%10==1){
      $("#dt_list_main li").show().eq(-1).hide();
    }else{
      $("#dt_list_main li").show()
    }
    $("#dt_list_main").show();
  },
  _addItem: function(userId, userNick, userImg, date, joinId) {
    //**敏感字校验**
    if (!verifyWord(userNick)) {
      userNick = '互动吧用户';
    }
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    var _item = "<li id=\"div_join_id_" + joinId + "\" class=\"dt_review_main\">" + "<div class=\"dt_review_K\"><div class=\"dt_guess_item_icon\"><a target='_blank' href=\"/timeline/" + userId + "-" + _khDuan._duanId + _thisNext + "List.html\">";
    if (userImg == "") {
      _item += "<img class=\"default_img\" src=\"" + _imgCdn + "/static_v4/images/other/face_default_200.png\"/>";
    } else {
      _item += "<img class=\"default_img\"  src=\"" + userImg + "\" onerror=\"this.src='" + _imgCdn + "/static_v4/images/other/face_default_200.png'\"/>";
    }
    _item += "</a></div> " + "<div class=\"dt_guess_item_title dt_loadNew\"><a target='_blank' href=\"/timeline/" + userId + "-" + _khDuan._duanId + _thisNext + "List.html\">" + _._htmlencode(userNick) + "</a></div>" + "<p class=\"dt_guess_item_time\">" + date + "</p>" + "</div>" + "</li>";
    return _item;
  }
};

/**赞相关*/
var _like = {
  _total: 0,
  _index: 1,
  _nowTime: 0,
  _post: function() {
	$("#dt_like a").attr("onclick","");
    _t._set("login_Way", 1);
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    if (!_user._login()) {
      _login4._show('tc_login');
      return;
    }
    _$(_api3._like, "h_share_uid=" + _info._shareUid + "&info_type=" + _info._type + "&info_id=" + _info._id, _like._ok);
  },
  _ok: function(json, code) {
    if (code != 200) {
      _like._likeFailed();
      $("#dt_like a").attr("onclick","_like._post()");
      return;
    }
    $("#dt_like a").attr("onclick","_like._post()");
    if (json.state.toString() != "0") {
      _toast._show(json.error, function() {
        _user._error(json.state, "like");
      });
      return;
    }
    _like._liked();
    _backToRefresh._mark();
    _likeBeforeLogin._mark("");
    var _item = _like._itemDom(json.user.user_id, json.user.user_name, json.user.user_pic);
    $("#dt_like_list .dt_like_num").after(_item);
    if($("#dt_like_list .dt_nick").length == 11){
  	  $("#dt_like_list .dt_nick").eq(10).remove();
    }
    if ($("#dt_like_count").attr("id") != undefined) {
      $("#dt_like_count").html(parseInt($("#dt_like_count").html()) + 1);
      $(".dt_like_num p b").html(parseInt($(".dt_like_num p b").html())+1);
      
      if($("#dt_like .zanWk img").attr('src')!=null && $("#dt_like .zanWk img").attr('src').indexOf('dt_xin_heart_select')==-1){
  		var img_src= $("#dt_like .zanWk img").attr('src').replace(/dt_xin_heart/,'dt_xin_heart_select');
  		$("#dt_like .zanWk img").attr('src',img_src);
  		$(".dt_like_p_Tit i").html("已赞");
      }
      
    } else {
      $("#dt_like p").html("&nbsp;<i>赞</i><b>(</b><span id=\"dt_like_count\">1</span><b>)</b>");
    }
    if(parseInt($("#dt_like_count").html())==0){
    	$("#dt_like_main").hide();
    }else{
    	$("#dt_like_main").show();
    }
    $("#icon_zan_ok2").show().css({"width":25+"px","height":23+"px"});
    $("#icon_zan_ok2").animate({
      width: "39px",
      height: "37px",
      left: "-7px",
      top: "-7px"
    }, 100, function() {
      $("#icon_zan_ok2").animate({
        width: "25px",
        height: "23px",
        left: "0px",
        top: "0px"
      }, 300), function(){
    	  $("#icon_zan_ok2").hide(); 
      };
    });
  },
  _getFlag: false,
  _get: function() {
    if (_like._getFlag) {
      return;
    }
    
    _like._getFlag = true;
    _$(_api3._likeList, "info_type=" + _info._type + "&info_id=" + _info._id + "&page_num=" + _like._index + "&now_time=" + _like._nowTime + "&count=" + _like._total, _like._getOk);
  },
  _getOk: function(json, code) {
    if (code != 200 || (code == 200 && json.state != "0")) {
      _like._getFlag = false;
      return;
    }
    var _data = json.likeArray,
      _len = _data.length;
    var _isLike = json.isLike;
    _like._nowTime = json.nowTime;
    if (_isLike != 1) {
      _likeBeforeLogin._continue();
    }
    if (_like._index == 1) {
      if (_isLike == 1) {
        _like._liked();
      }
      _like._total = json.total;
      if (json.total > 0) {
        $("#dt_like p").html("&nbsp;<i>赞</i><b>(</b><span id=\"dt_like_count\">" + json.total + "</span><b>)</b>");
        $(".dt_like_num p").html("<b>"+json.total+"</b>人 赞过");
        if($("#dt_like .zanWk img").attr('src')!=null && $("#dt_like .zanWk img").attr('src').indexOf('dt_xin_heart_select')==-1 && _isLike == 1){
			if(_user._login()){//登陆了
				var img_src= $("#dt_like .zanWk img").attr('src').replace(/dt_xin_heart/g,'dt_xin_heart_select');
	    		$("#dt_like .zanWk img").attr('src',img_src);
	    		$(".dt_like_p_Tit i").html("已赞");
		    }
        }
      }
    }
    if ($("#dt_like_more").attr("href") != undefined) {
      $("#dt_like_more").remove();
    }
    for (var i = 0; i < _len; i++) {
      $("#dt_like_list").append(_like._itemDom(_data[i].userId, _data[i].nickName, _data[i].userPic));
    }
    var _likeH = $("#dt_like_list .dt_nick").length;
    if(_likeH>10){
    	$("#dt_like_list .dt_nick").each(function(){
    		if($(this).index()>10){
    			$(this).remove();
    		}
    	});
    }
    if (json.nextState == "1") {
      var _a = "<a id=\"dt_like_more\" class=\"dt_nick\" onclick=\"_like._get()\" href=\"javascript:void(0)\">&nbsp;&nbsp;更多…</a>";
      $("#dt_like_list").append(_a);
      if($("#dt_like_list .dt_nick").length == 11){
    	  $("#dt_like_list .dt_nick").eq(10).remove();
      }
      _like._getFlag = false;
      _like._index++;
    }
  },
  _liked: function() {
    if ($("#dt_like").children("a").attr("href") == undefined) {
      return;
    }
    var _src = $("#img_dt_like").attr("src");
    $("#img_dt_like").attr("src", _src.replace("dt_like2.png", "dt_like_yes.png"));
    if($('#dt_like a').length>=1){return;}else{
    $("#dt_like").html('<a href="javascript:_like._post()">'+$("#dt_like").children().eq(0).html()+'</a>');
    }
  },
  _likeFailed: function() {
	    if($('#dt_like a').length>=1){return;}else{
    $("#dt_like").html("<a href='javascript:_like._post()'>" + $("#dt_like").html() + "</a>");
	    }
  },
  _itemDom: function(userId, userName, userPic) {
    //**敏感字校验**
    if (!verifyWord(userName)) {
      userName = '互动吧用户';
    }
    var _thisNext = _info._type.replace(_info._type, function($1) {
      return $1 ? ($1.substring(0, 1).toUpperCase() + $1.substring(1)) : '';
    });
    var _a = "<a target='_blank' href=\"/timeline/" + userId + "-" + _khDuan._duanId + _thisNext + "Like.html\" class=\"dt_nick\" id=\"dt_like_list_" + userId + "\"><img src=\'"+ userPic + "' onerror='this.src=\""+_imgCdn + "/static_v4/images/other/face_default_200.png\""+"' /><span>" + userName + "</span></a>";
    setTimeout(_like._get, 500);
    return _a;
  },
  _init: function() {
    setTimeout(_like._get, 500);
  }
};
var _likeBeforeLogin = {
  _mark: function(value) {
    _t._set("like_before_login_" + _info._type + "_" + _info._id, value);
  },
  _continue: function() {
    if (_t._get("like_before_login_" + _info._type + "_" + _info._id) != "") {
      _like._post();
      setTimeout(function() {
        _scroll._to($("#dt_like").scrollTop() - 100);
      }, 500);
    }
  }
};
/**阅读、分享*/
var _infoHintsShare = {
  _post: function() {
    _$(_api3._infoHintShare, "info_id=" + _info._id + "&info_type=" + _info._type, _infoHintsShare._ok);
  },
  _ok: function(json, code) {
    if (json != null) {
      $("#info_hits").html("阅读 " + json.hits);
      if (json.share > 0) {
        $("#info_share").html("分享 " + json.share + "+");
      } else {
        $("#info_share").html("分享 " + json.share);
      }
    }
    $(".subinfo_name").css("max-width", ($("body").width() - 85 - $(".fbTime").width() - $(".dt_review_item_count").width()) + "px");
  }
};

/**外链*/
var _support = {
  _url: "",
  _format: function(id) {
    var _html = $("#" + id).html();
    var _reg = /([^"])((https?:\/\/)([a-zA-Z0-9][-a-zA-Z0-9]{0,62}(\.[a-zA-Z0-9][-a-zA-Z0-9]{0,62})+\.?)(\/[a-zA-Z0-9\?%=&#;_\.\-\+\/]+)?)/gi;
    _html = _html.replace(_reg, function(data) {
      var _dataTemp = data.substring(1, data.length);
      var _pre = data.substring(0, 1);
      if (data.indexOf("qq.com") > -1 || data.indexOf("youku.com") > -1) {
        return data;
      } else if (data.indexOf(_domain) > -1 || data.indexOf("hudong.ba") > -1 || data.indexOf("hudongba.mobi") > -1 || data.indexOf("hdb.com") > -1 || _isNoAlertUser == "1") {
        return _pre + "<a class='dt_hdb_support' href='" + _dataTemp + "'>" + _dataTemp + "</a>";
      } else {
        return _pre + "<a class='dt_support' href='javascript:void(0);' onclick='_support._hint(\"" + _dataTemp + "\")'>" + _dataTemp + "</a>";
      }
    });
    _html = _html.replace(/\'([^\']*)\'/ig, function(a) {
      return a.replace(/((from)|(isappinstalled))=/ig, "");
    });
    $("#" + id).html(_html);
    _html = null;
  },
  _hint: function(temp) {
    _support._url = temp;
    _support._box();
  },
  _init: function() {
    if ($("#dt_content").attr("id") != undefined) {
      _support._format("dt_content");
    }
    if ($("#dt_contact_content").attr("id") != undefined) {
      _support._format("dt_contact_content");
    }
    if ($("#dt_vote_result").attr("id") != undefined) {
      _support._format("dt_vote_result");
    }
  },
  _infoPanel: function(json, code) {
    if (code != 200) {
      return;
    }
    HudongbaJsBridge["showPostInfoPanel"](json.template.template_type, json.template.template_title, json.template.template_content, json.template.template_text);
  },
  _center: function() {
    var _top = _._zero(_._client().bh - $("#tc_support").outerHeight()) / 2 + "px";
    var _left = _._zero(_._client().bw - $("#tc_support").outerWidth()) / 2 + "px";
    $("#tc_support").css({
      "left": _left,
      "bottom": _top,
      "z-index": "3000",
      "position": "fixed"
    });
  },
  _box: function() {
    _cover._show("cover2");
    _support._center();
    $("#tc_support").show();
    $("#cover2").bind("click", _support._hide);
  },
  _hide: function() {
    $("#tc_support").hide();
    _cover._hide("cover2");
  },
  _ok: function() {
    _support._hide();
    _g(_support._url);
  }
};

function detail2Js_pc() {
  var y = $(window).height();
  $(".content-body").css("min-height", y + "px");
};

function detail2Js_mb() {
  var y = $(window).height(),
    w = $("body").width();
  $(".inviteZu li span").width(w * 0.137);
  $(".inviteZu li span").height(w * 0.137);
  $(".subinfo_name").css("max-width", w - 85 - $(".fbTime").width() - $(".dt_review_item_count").width() + "px");
  $(".dt_join_barR").css({
    "width": $("body").width() - 35 - $(".dt_join_barL").width() + "px",
    "margin-right": 15 + "px",
    "margin-left": 0
  });
  $(".tc_c_feiLi").css("max-height", (y - 144) + "px");
};
window.onscroll = function() {
  var barTop = $(document).scrollTop();
  $(".content-sidebar").css("margin-top", barTop + 50 + "px");
};
/**强制刷新*/
var _reFresh = function() {
  if (_backToRefresh._should()) {
    _backToRefresh._clear();
    _g(document.location.href);
  };
};
//视频高度
function _listener() {
  var w = $("body").width();
  var y = $(window).height();
  if (w > y) {
    w = y;
  }
  $(".iframe_mov").width(w - 30);
  $(".iframe_mov").height((w - 30) * 372 / 450);

  setTimeout(function() {
    detail2Js_mb();
  }, 1000);
};
//名信片
var _useCare = {
  _flag: false,
  _initFirst: function() {
    if (($("#dt_review").offset().top + $("#dt_review").height() - $(window).height()) < $(document).scrollTop()) {
      _useCare._post();
    }
  },
  _init: function() {
    _useCare._post();
  },
  _post: function() {
    if (_useCare._flag) {
      return;
    }
    _useCare._flag = true;
    _$(_detailApi3._care, "userId=" + $("#postUserId36").val(), _useCare._ok);
  },
  _ok: function(json, code) {
    if (code != 200) {
      return;
    }
    var _html = "";
    if (json != null) {
      var _data = json.data;
      var _len = _data.length;
      if (_len < 4) {
        return;
      }
      var _pSize = 0;
      for (var i = 0; _pSize < 3 && i < _len; i++) {
        var _d = _data[i];
        if (!(_info._id == _d.infoId36 && _info._type == _d.infoType)) {
          _html += _useCare._item(_d);
          _pSize++;
        }
      }
    }
    $(".dt_carte_num span").html(json.count);
    $(".dt_carte_list ul").html(_html);
    $("#dt_carte").show();
  },
  _item: function(d) {
    var _item = "";
    _item = '<li><a href="/' + d.infoType + '/' + d.infoId36 + '?hdb_from=DSelf" class="dt_carte_list_a">' + '<img src="' + _imgCdn + '/images3/icon/' + d.infoType + '2x.png" class="dt_carte_list_pic" />' + '<div class="dt_carte_list_title">' + d.infoTitle + '</div>' + '</a></li>';
    return _item;
  }
};

var _khDuan = {
  _duanId: "",
  _init: function() {
	_khDuan._duanId = "PC";
  }
};

/**评论、参与、猜你喜欢loading*/
var _bottomLoading = {
  _end: function(id, text) {
    $("#" + id).html("<span class=\"upAll font03\">" + text + "</span>");
    $("#" + id).unbind("click");
    $("#" + id).show();
  },
  _loading: function(id, text) {
    $("#" + id).html("<span class=\"upding font03\"><img src=\"" + _imgCdn + "/images3/loading2.gif\">" + text + "</span>");
    $("#" + id).unbind("click");
    $("#" + id).show();
  },
  _more: function(id, text, fun) {
    $("#" + id).html("<a class=\"moreBtn font03\"><span>" + text + "</span></a>");
    $("#" + id).bind("click", fun);
    $("#" + id).show();
  },
  _hide: function(id) {
    $("#" + id).hide();
  }
};

//发布数
var _stock = {
  _get: function() {
    _$(_api3._stock, "info_id=" + _info._id + "&info_type=" + _info._type, _stock._success);
  },
  _success: function(json, code) {
    if (json != null) {
      $("#totalPost").text(json.totalPost);
    }
  }
};

/**敏感字校验、生成赞列表、参与列表、评论列表时，校验是否含有敏感字**/
function verifyWord(str) {
  var filterRegex1 = /\+v|\+V|加v|加V|加微/;
  var filterRegex2 = /(.*)(\+|加|v|V|红包|微信|朋友)(.*)[0-9a-zA-Z]{6,}/;
  var filterRegex3 = /(.*)[0-9a-zA-Z]{6,}(.*)(\+|加|v|V|红包|微信|朋友)/;
  if (filterRegex1.test(str)) {
    return false;
  }
  if (filterRegex2.test(str)) {
    return false;
  }
  if (filterRegex3.test(str)) {
    return false;
  }
  return true;
}

$(".tc_c2 .join_box_Xq ul li,.danX_p,#ul_join_property li").click(function() {
  $(this).addClass("thisOver").siblings().removeClass("thisOver");
});
$(".duoX_p span").click(function() {
  $(this).parent().toggleClass("thisOver");
});
$(".danX_p,.duoX_p").each(function() {
  var x = $(this).children("strong").html();
  x = _._len(x);
  if (x > 10) {
    $(this).parent("div").children("p").css("width", "100%");
  }
});
$(".user_address_ul li a").click(function() { //地域筛选
  var _area_id = $(this).attr("id");
  var _area_name = $(this).html();
  var _area_code = $(this).attr("name");
  if (_area_code == "-1") {
    window.location.href = "" + _info._domain + "quanguo/";
  } else {
    window.location.href = "" + _info._domain + _area_code + "/";
  }
});

//邀请码
var _partyInvite = {
  _post: function() {
    var _code = _._trim($("#dt_invite_form_code").val());
    if (_code == "") {
      _toast._show("请输入邀请码");
      return;
    }
    if (_._len(_code) > 30) {
      _toast._show("邀请码不正确");
      return;
    }
    _loading._show("请稍候");
    _$(_api3._checkInviteCode, "info_id=" + _info._id + "&info_type=" + _info._type + "&code=" + _._encode(_code), _partyInvite._ok);
  },
  _ok: function(json, code) {
    _loading._hide();
    if (code != 200) {
      return;
    }
    _g(location.href.toString());
  }
};
//投票
var _vote ={
  _loginMark:function(value){
        _t._set("vote_before_login_"+_info._type+"_"+_info._id,value);
    },
  _selArr:[],
  _scaleArr:[],
   _post:function(){
    _t._set("login_Way",8);
      var _selected=_option._getSelected();
      if(_selected!="" && !_user._inHudongba()){_option._setTemp(_selected);}
      if(_info._power=="1"){_toast._show("该投票需要验证邮箱后才能参与");return;}
      if(_selected==""){
          _scroollTop._top(".dt_vote");
        _toast._show("你没有作出任何选择");        
        return;
      }
      if(_info._kind==1&&_selected.indexOf(",")>0){
          _toast._show("单选只能选择一个选项");       
        return;
      }
      if(_info._kind==0&&_info._count!=0&&_selected.split(",").length>_info._count){
         _toast._show("本投票最多只能选"+_info._count+"项");       
        return;
      }
      if(!_user._login()){
         if(!_user._inHudongba()){_vote._loginMark("1");}
        _login4._show('tc_login');
        return;
      }
      _loading._show("请稍候");
      _$(_api3._vote,"h_share_uid="+_info._shareUid+"&vote_id="+_info._id+"&options="+_selected,_vote._ok);
   },
   _ok:function(json,code){
      _loading._hide();
    if(code!=200){return;}
    if(json.state.toString()!="0"){
      _toast._show(json.error,function(){
        _user._error(json.state,"vote");
      });
      return;
    }
    _option._setTemp("");
    _backToRefresh._mark();
    _vote._loginMark("");
    var _totalCount=0,
            _data=json.vote_option,
            _len=_data.length,
            _joinOptionIds=json.join_option_ids,
            _joinOptionCount = json.join_option_count,
            _isUseMq = json.is_use_mq;
       var selectedIdArray = new Array();
       selectedIdArray = _joinOptionIds.split(",");
    for(var i=0;i<_len;i++){
       _totalCount+=parseInt(_data[i].counts);

       if(_isUseMq == "1"){

            if(selectedIdArray.indexOf(_data[i].id)>-1){
                _data[i].counts = _data[i].counts + 1;
            }
       }
    }
    if(_isUseMq == "1"){
        _totalCount += _joinOptionCount;
    }
    $("#span_join_count").html(_totalCount);
    if(_info._kind==0){$("#dt_vote_main").attr("class","dt_vote_main duoXuanJg");}else{$("#dt_vote_main").attr("class","dt_vote_main danXuanJg");}
    var _html ="";
    for(var ii=0;ii<_len;ii++){
      _html+= _vote._addItem(_data[ii].id,_data[ii].option,_data[ii].counts,_totalCount,_joinOptionIds);
    }
    if(_._trim($("#dt_vote_result").html())!=""){$("#vote_result").show();}
    $("#span_decrip").hide();
    $("#dt_vote_main").html(_html);
    for(var i=0,_len=_vote._selArr.length;i<_len;i++){
        var _no = 100-_vote._scaleArr[i];
      $("#yes"+_vote._selArr[i]).animate({width:_vote._scaleArr[i]+"%"}, "slow");
    }
    $("#dt_join_bar_title").html("<a href='javascript:void(0);' class='xd_btn_r style02'><img src='"+_info._img1Url+"/static_v4/images/detail/xd_icon_4.png' alt='' /><span>已投票</span></a>");
    dataForShare.title="我参与了《"+dataForShare.title+"》，你也来看看吧";
    if(_user._inWeixin()){onBridgeReady_new();}
    setTimeout(function(){_vote._sucess();},1600);
    $("#a_post").attr("href","/post??hdb_from=PCEnrollVote");
   },
   _addItem:function(id,option,count,totalCount,joinOptionIds){
      var _scale;

       if(totalCount == 0){
           _scale = 0.0;
       }else{
           _scale = Number(Math.round(count/totalCount*10000)/100).toFixed(1);
       }

    var _userCk = ""
    if((","+joinOptionIds+",").indexOf(","+id+",")!=-1){
      _userCk = "thisOver";
    }   
    _vote._selArr.push(id);
    _vote._scaleArr.push(_scale);     
    var _item = "<li class=\"dt_vote_list "+_userCk+"\">"
		 + "<div class=\"dt_vote_jg\"><div class=\"dt_vote_list_icon\"><span></span></div>"
		 +"<div class=\"dt_vote_list_title\"><a class=\"font03\" href=\"javascript:void(0);\">"+option+"</a></div>"
		 +"<div class=\"dt_vote_jg_num\"><p class=\"font04\">"+count+"票 "+_scale+"%</p></div></div><div class=\"jinduTiao\">"
		 +"<div id=\"yes"+id+"\" style=\"width: 0%;\" class=\"dt_list_item_vote_scale_yes vote_scale_yes\"></div></div></li>";
  return _item;
   },
   _sucess:function(){
	   _tc._show('tc_chengNopay_vote');
   }
};
//投票设置
var funParabola = function(element, target, options) {
  var defaults = {
    speed: 166.67,
    curvature: 0.001,
    progress: function() {},
    complete: function() {}
  };
  var params = {};
  options = options || {};
  for (var key in defaults) {
    params[key] = options[key] || defaults[key];
  }
  var exports = {
    mark: function() {
      return this;
    },
    position: function() {
      return this;
    },
    move: function() {
      return this;
    },
    init: function() {
      return this;
    }
  };
  var moveStyle = "margin",
    testDiv = document.createElement("div");
  if ("oninput" in testDiv) {
    ["", "ms", "webkit"].forEach(function(prefix) {
      var transform = prefix + (prefix ? "T" : "t") + "ransform";
      if (transform in testDiv.style) {
        moveStyle = transform;
      }
    });
  }
  var a = params.curvature,
    b = 0,
    c = 0;
  var flagMove = true;
  if (element && target && element.nodeType == 1 && target.nodeType == 1) {
    var rectElement = {},
      rectTarget = {};
    var centerElement = {},
      centerTarget = {};
    var coordElement = {},
      coordTarget = {};
    exports.mark = function() {
      if (flagMove == false) return this;
      if (typeof coordElement.x == "undefined") this.position();
      element.setAttribute("data-center", [coordElement.x, coordElement.y].join());
      target.setAttribute("data-center", [coordTarget.x, coordTarget.y].join());
      return this;
    };
    exports.position = function() {
      if (flagMove == false) return this;
      var scrollLeft = document.documentElement.scrollLeft || document.body.scrollLeft,
        scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
      if (moveStyle == "margin") {
        element.style.marginLeft = element.style.marginTop = "0px";
      } else {
        element.style[moveStyle] = "translate(0, 0)";
      }
      rectElement = element.getBoundingClientRect();
      rectTarget = target.getBoundingClientRect();
      centerElement = {
        x: rectElement.left + (rectElement.right - rectElement.left) / 2 + scrollLeft,
        y: rectElement.top + (rectElement.bottom - rectElement.top) / 2 + scrollTop
      };
      centerTarget = {
        x: rectTarget.left + (rectTarget.right - rectTarget.left) / 2 + scrollLeft,
        y: rectTarget.top + (rectTarget.bottom - rectTarget.top) / 2 + scrollTop
      };
      coordElement = {
        x: 0,
        y: 0
      };
      coordTarget = {
        x: -1 * (centerElement.x - centerTarget.x),
        y: -1 * (centerElement.y - centerTarget.y)
      };
      b = (coordTarget.y - a * coordTarget.x * coordTarget.x) / coordTarget.x;
      return this;
    };
    exports.move = function() {
      if (flagMove == false) return this;
      var startx = 0,
        rate = coordTarget.x > 0 ? 1 : -1;
      var step = function() {
        var tangent = 2 * a * startx + b;
        startx = startx + rate * Math.sqrt(params.speed / (tangent * tangent + 1));
        if ((rate == 1 && startx > coordTarget.x) || (rate == -1 && startx < coordTarget.x)) {
          startx = coordTarget.x;
        }
        var x = startx,
          y = a * x * x + b * x;
        element.setAttribute("data-center", [Math.round(x), Math.round(y)].join());
        if (moveStyle == "margin") {
          element.style.marginLeft = x + "px";
          element.style.marginTop = y + "px";
        } else {
          element.style[moveStyle] = "translate(" + [x + "px", y + "px"].join() + ")";
        }
        if (startx !== coordTarget.x) {
          params.progress(x, y);
          window.requestAnimationFrame(step);
        } else {
          params.complete();
          flagMove = true;
        }
      };
      window.requestAnimationFrame(step);
      flagMove = false;
      return this;
    };
    exports.init = function() {
      this.position().mark().move();
    };
  }
  return exports;
};
//投票设置
var _option = {
  _shan: true,
  _getSelected: function() {
    var _selected = "";
    $("li[class='dt_vote_list thisOver']").each(function() {
      _selected += "," + $(this).attr("optionid");
    });
    _selected = _selected.replace(/^\,/g, "");
    return _selected;
  },
  _click: function(obj, type) {
    var _crruentClass = $(obj).attr("class");
    if (_crruentClass.indexOf("thisOver") == -1) {
      if (_info._kind == 0 && _info._count != 0 && $("#dt_vote_main li[class$='thisOver']").length >= _info._count) {
        _toast._show("本投票最多只能选" + _info._count + "项");
        return;
      }
    }
    $(obj).attr("class", "dt_vote_list " + (_crruentClass.indexOf("thisOver") == -1 ? "thisOver" : ""));
    if (type == 'single') {
      $(obj).siblings().removeClass("thisOver");
    }
    if (!_postSucess._fromApp() && _info.state != "0") {
      if ($(obj).attr("class") == "dt_vote_list thisOver") {
        _option._move(obj);
      }
    }
  },
  _getTemp: function() {
    if (_t._get("vote_before_login_" + _info._type + "_" + _info._id) != "1") {
      return;
    }
    var _joinOptionIds = _t._get("join_vote_" + _info._id);
    if (_joinOptionIds != "" && _info._join != "1" && _info._lock == false) {
      $("li[class^='dt_vote_list']").each(function() {
        var _id = $(this).attr("optionid");
        if (("," + _joinOptionIds + ",").indexOf("," + _id + ",") != -1) {
          $(this).addClass("thisOver");
        }
      });
      setTimeout(function() {
        _scroollTop._top(".dt_vote");
        _vote._post();
      }, 500);
    }
  },
  _setTemp: function(value) {
    _t._set("join_vote_" + _info._id, value);
  },
  _move: function(obj) {
    $("#flyItem").show();
    var eleFlyElement = document.querySelector("#flyItem"),
      eleShopCart = document.querySelector("#dt_join_bar_title");
    var myParabola = funParabola(eleFlyElement, eleShopCart, {
      speed: 400,
      curvature: 0.002,
      complete: function() {
        $("#flyItem").hide();
        $(".zTai01").animate({
          top: "-20px"
        }, 50);
        setTimeout(function() {
          $(".zTai01").animate({
            top: "0"
          }, 100);
        });
      }
    });
    myParabola.position().move();
  }
};
(function() {
  var lastTime = 0;
  var vendors = ['webkit', 'moz'];
  for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
    window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
    window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] ||
      window[vendors[x] + 'CancelRequestAnimationFrame'];
  }
  if (!window.requestAnimationFrame) {
    window.requestAnimationFrame = function(callback, element) {
      var currTime = new Date().getTime();
      var timeToCall = Math.max(0, 16.7 - (currTime - lastTime));
      var id = window.setTimeout(function() {
        callback(currTime + timeToCall);
      }, timeToCall);
      lastTime = currTime + timeToCall;
      return id;
    };
  }
  if (!window.cancelAnimationFrame) {
    window.cancelAnimationFrame = function(id) {
      clearTimeout(id);
    };
  }
}());

function getPageNum(){
  var currentPage = $(".page_number li").children(".current").attr("id");
  if(currentPage == undefined){
   return "1";
  }
  return currentPage;
}

function getStartDate(){
	var start_date = $(".post_tiMe4").val();
	$("#hd_time").children("li").children("a").removeClass("thisOver");
	pageinationView(getPageNum());
}

function pageinationView(currentPage) {
  var _category_id = $("#hd_type li").children(".thisOver").attr("id");
  var _start_date = $("#hd_time li").children(".thisOver").attr("id");
  var _is_charge = $("#hd_pay li").children(".thisOver").attr("id");
  var _area_id = $(".user_address_t").children("span").attr("id");
  var _area_code = $(".user_address_t").children("span").attr("name");
  var _area_name = $(".user_address_t").children("span").html();
  var actionUri = "/find/";
  if (_area_id == "-1") {
    actionUri = actionUri + "quanguo";
  } else if (area_code != "-1" && area_code != undefined) {
    if (area_code != "") {
      actionUri = actionUri + area_code;
    } else {
      actionUri = actionUri + _area_code;
    }
  }
  if (_category_id != "-1") {
    actionUri = actionUri + "-fl" + _category_id;
  }
  if (_start_date) {
    actionUri = actionUri + "-sj" + _start_date;
    $(".post_tiMe4").val("");
  }
  if (_is_charge != "-1") {
    actionUri = actionUri + "-fy" + _is_charge;
  }
  actionUri = actionUri + "-p" + currentPage;
  var _start_time = $(".post_tiMe4").val();
  if (_start_time) {
    actionUri = actionUri + "?start_time=" + _start_time;
  } else {
    actionUri += "/";
  }
  window.location = actionUri;
}

if (_info._type == "find") {
  $("#confirmed").click(function() {
    var skipNumber = $("#skipNumber").val();
    if (isNaN(skipNumber)) {
      skipNumber = _info._total_page;
    } else if (parseInt(skipNumber) >= parseInt(_info._total_page)) {
      skipNumber = _info._total_page;
    }
    pageinationView(skipNumber);
  });
  var area_code = "";
  $(".user_address_ul li a").click(function() { //地域筛选
    var _area_id = $(this).attr("id");
    var _area_name = $(this).html();
    area_code = $(this).attr("name");
    $(".user_address_t").children("span").attr("id", _area_id);
    $(".user_address_t").children("span").html(_area_name);
    pageinationView(1, _area_id);
  });
  $(".select_ul li a").click(function() { //活动筛选
    $(this).parent().parent().children("li").children("a").removeClass("thisOver");
    $(this).addClass("thisOver");
    var _name = $(this).find("span").html();
    pageinationView(1);
  });
}

var _payList = {//pc端报名收费项 数量变更
  _add:function(){
    if($(".tc_c_feiLi").length!="0" && $(".tc_c_feiLi .select .ticket_all .ticket_det .num").html()=="已卖完"){
      $(".tc_c_feiLi .select .ticket_all .ticket_det .num").html("剩余：<b>1</b>")
    }else if($(".tc_c_feiLi").length!="0" && $(".tc_c_feiLi .select .ticket_all .ticket_det .num b").length!="0"){
      $(".tc_c_feiLi .select .ticket_all .ticket_det .num b").html(parseInt($(".tc_c_feiLi .select .ticket_all .ticket_det .num b").html())+1);
    }
  },
  _less:function(){
    if($(".tc_c_feiLi").length!="0" && $(".tc_c_feiLi .select .ticket_all .ticket_det .num b").length!="0"){
      $(".tc_c_feiLi .select .ticket_all .ticket_det .num b").html(parseInt($(".tc_c_feiLi .select .ticket_all .ticket_det .num b").html())-1);
      if($(".tc_c_feiLi .select .ticket_all .ticket_det .num b").html()=="0"){
      	$(".tc_c_feiLi .select .ticket_all .ticket_det .num").html("已卖完");
      }
    }
  }
};

var _getShopInfo = {

    _init : function(){
        //_$(_api3._shopInfo, "user_id=" + _info._postUid, _getShopInfo._getOk)
    },

    _getOk : function(obj){

        var user_name = obj.user_name;
        var user_desc = obj.user_desc;
        var user_pic = obj.user_pic;
        var post_count = obj.post_count;
        var join_count = obj.join_count;

        if(user_desc == "" || user_desc == "这里是个人简介!"){
            user_desc = "TA组织活动太忙，还没腾出空写简介";
        }
        if(user_pic == ""){
        	$("#detail_r_pc .aside_topR_pic a").html("<img src='" + _imgCdn + "/static_v4/images/other/face_default_200.png'/>");
        }else{
        	$("#detail_r_pc .aside_topR_pic a").html("<img src='"+user_pic+"'>");
        }
        //$("#detail_r_pc .aside_topR_pic a").html("<img src='"+user_pic+"' onerror=\"this.src='" + _imgCdn + "/static_v4/images/other/face_default_200.png'\"/>");
        $("#detail_shop_name,#subinfo_name").html(user_name);
        $("#detail_shop_desc").html(user_desc);
        $("#detail_post_count").html(post_count);
        $("#detail_join_count").html(join_count);

        if(obj.his_partys){
            var html = "";

            html += "<div class=\"her_party\">";
            html += "<div class=\"her_party_tit\"><p>TA的活动</p></div>";
            html += "<ul class=\"her_party_con\">";

            for(var i=0; i<obj.his_partys.length; i++){
                var item = obj.his_partys[i];
                html += "<li><a href='/party/" + item.info_id36 + "'><b></b><span>" + _._htmlencode(item.info_title) + "</span></a></li>";
            }
            html += "</ul>";
            html += "</div>";

            $(".detail_time_attr_det_aside").append(html);
            $(".her_party_con li").each(function(){
              var _i = $(this).index()+1;
              $(this).attr("id","hisParty"+_i);
              //$(this).find("b").html(_i);
            });
        }


    }

};

//TODO 页面初始化设置
$(document).ready(function(){
  if(_info._type=="party"||_info._type=="article"||_info._type=="vote"){
    $("#dt_content").html(_info._fileContnet);
  }
  detail2Js_pc();

  _getShopInfo._init();

  $(".tc_preview").click(function() {
    _toast._show("这是预览页面，先编辑完成后再点击查看", 100);
  });
  $("#a_post").attr("target", "_blank");
  $("#a_detail_right").attr("target", "_blank");
  _support._init();
  //_hdbLoad._run(".dt_content_pic img");
  if (_info._type != "find") {
    _infoHintsShare._post();
    _share._init();
    _like._init();
    _reviewLoading._init();
    _reFresh();
    _postSucess._init();
    _khDuan._init();
    _recommend._init();
  }
  _isFocus._init();
  //预览页面设置
  if (_info._pre_View == "1") {
    $("#div_share_type,.dt_post_sucess,#dt_join_menu_bg,.dt_post_sucess,.bshare-custom").hide();
    $("#dt_join_bar").show();
    $("#dt_join_bar").css("bottom", 0);
    $(".content-body a,.dt_join_barC_nr a,.footer_gray a,#dt_review_top,.dt_join_top,.dt_review_top,.detail_left_aside_me_index").removeAttr("onclick");
    $(".content-body a,.dt_join_barC_nr a,.footer_gray a,.dt_guess_list,.dt_join_barC_nr a,.aside_topR_pic a,.aside_topR_tit a").removeAttr("href");
    $(".content-body a,.dt_join_barC_nr a,.footer_gray a,#dt_like,.dt_review_top,.dt_carte_new,.dt_join_bar_outside").addClass("tc_preview");
    $(".dt_review_item_count").html('<span>阅读 0　分享 0</span>');
    setTimeout(function() {
      $(".dt_guess_list,#dt_join_bar_menu").removeAttr("href").addClass("tc_preview");
      $("#fxicon_qq").css({
        "visibility": "hidden"
      });
      $(".tc_preview").click(function() {
        _toast._show("这是预览页面，先编辑完成后再点击查看");
      });
    }, 500);
  }
  $("[v_src]").each(function() {
    var vsrc = $(this).attr("v_src");
    $(this).attr("src", vsrc);
  });
  if (_info._type == "party") {
    var virtualAr = [];
    _joinLoading._init();
    _manage._init();
    _joinForm._init('party');
    var way = _t._get('login_Way');
    _payItemBox._check_ispay2();
    $("#hide_verify_mobile").val("0");//手机验证码
    var ticket = $('.tc_c_feiLi li');
	var ticket_len = ticket.length;
	var join = $('.detail_join_ticket_con .join li');
	if($('.tc_c_feiLi li').length>3){
		$(".tc_c_feiLi").css({"text-align":"left","padding-left":15+"px"});
	}	
	//推荐
	var detail_tab = $('.detail_tab .detail_tab_nav li');
	detail_tab.click(function(){
		var _detail_tab_index = $(this).index();
		$(this).addClass('thisOver').siblings('li').removeClass('thisOver');
		$('#hd_'+$(this).attr('id')).show().siblings('div').hide();
	});
    if(_info._isPay == "1" && _info._joinPayItemId != "0"){
        $(".tc_c_feiLi li").each(function(){
            if($(this).attr("payitemid") == _info._joinPayItemId){
                $(this).addClass("select");
                $(this).unbind("click");
            }else{
                $(this).removeClass("select");
                $(this).unbind("click");
            }
        });
    }
    $(".ticket_money").each(function() {
	    if ($(this).html() == "¥0") {
	    	$(this).html("免费");
	    }
	  });
    if($(".detail_t_join a").html()=="去支付"||$(".detail_t_join a").html()=="已报名"||$(".detail_t_join a").html()=="报名已关闭"||$(".detail_t_join a").html()=="人数已满"){
		$(".tc_c_feiLi li").each(function(){
			$(this).unbind("click");
        });
	}else{
		$('.tc_c_feiLi li').click(function(){
		  if(_info._pre_View!="1"){
			var _index = $(this).index();
			$(this).addClass('select').siblings('li').removeClass('select');
			join.eq(_index).addClass('show').siblings('li').removeClass('show');
			if($(this).find(".num").html()=="已卖完"){
				$(".detail_t_join a,.xd_btn_r").css({"background-color":"#cccccc","cursor":"default"}).attr("onclick","");
			}else{
				$(".detail_t_join a,.xd_btn_r").css({"background-color":"#0099e9","cursor":"pointer"}).attr("onclick","_payItemBox._show('"+_info._type+"')");
			}
		  }
		});
	}
  } else if (_info._type == "vote") {
    _option._getTemp();
  } else if (_info._type == "recruit") {
    var virtualAr = [];
    _joinLoading._init();
    _manage._init();
    _joinForm._init('recruit');
  } else if (_info._type == "find") {
	  $(".find_hd_2wm").each(function() {
	      var url = $(this).children(".trans").attr("id");
	      var qr = $(this).find(".img");
	      var qrcode = new QRCode($(this).find(".img")[0], {
		    width : 80,//设置宽高
		    height : 80
		  });
	      qrcode.makeCode(url);
	});
    if(_info._type!="find"){
      var url2 = _domain + _info._type + "/" + _info._id;
	  var qrcode = new QRCode(document.getElementById("canvasimage"), {
	    width : 200,//二维码设置宽高
	    height : 200
	  });
	  qrcode.makeCode(url2);
    }
    $("#hotArea").find("a").each(function(index) {
      var areaName = $("#hotArea").find("a:eq(" + index + ")").html().substring(0, 2);
      $("#hotArea").find("a:eq(" + index + ")").html($("#hotArea").find("a:eq(" + index + ")").html().substring(areaName.length - 2, areaName.length) + _info._category_name + "活动");
      var area_code_ = $("#hotArea").find("a:eq(" + index + ")").attr("name");
      $("#hotArea").find("a:eq(" + index + ")").attr("href", _info._domain + "find/" + area_code_ + "-fl" + _info._category_id + "-sjbx-p1/");
    });
    var i = 0;
    var h = $(".hot_week_ul li").length;
    var ti = "";
    for (i = 0; i < h; i++) { //设置热门活动小图标
      ti = $(".hot_week_ul li span")[i];
      imgName = i * 1 + 1;
      $(ti).append('<img src="' + _info._img1_url + '/static_v4/images/detail/hot' + imgName + '.png"  />');
    }
    $(".find_main_ul li").each(function() { //设置列表中有无图片的样式
      var item = $(this).children("a").children(".hd_pic")[0];
      if (item) {
        $(this).addClass("img");
      }
    });
    $(".find_hd_join_num").each(function() { //有无报名的文字显示
      var it = $(this).children("b").html();
      if (it == 0) {
        $(this).hide();
        $(this).prev("span").show();
      }
    });
    $("#hd_type li").each(function() { //类目筛选
      var _category_id = $(this).children("a").attr("id");
      if (_category_id == _info._category_id) {
        $(this).parent().children("li").children("a").removeClass("thisOver");
        $(this).children("a").addClass("thisOver");
      }
    });
    if (_info._start_date == "" && _info._start_time != "") {
      $("#hd_time").children("li").children("a").removeClass("thisOver");
    } else {
      $(".post_tiMe4").val("");
      $("#hd_time li").each(function() { //时间筛选
        var _start_date = $(this).children("a").attr("id");
        if (_start_date == _info._start_date) {
          $(this).parent().children("li").children("a").removeClass("thisOver");
          $(this).children("a").addClass("thisOver");
        }
      });
    }
    $("#hd_pay li").each(function() { //收费筛选
      var _is_charge = $(this).children("a").attr("id");
      if (_is_charge == _info._is_charge) {
        $(this).parent().children("li").children("a").removeClass("thisOver");
        $(this).children("a").addClass("thisOver");
      }
    });
    $('.post_tiMe4').date_input();
    _hdbLoad._run(".hd_pic");
    var l = $(".hot_week_ul li").length; //右侧列表，去除尾行底线
    $(".hot_week_ul li").each(function() {
      if ($(this).index() == l - 1) {
        $(this).children("div").css("border-bottom", "none");
      }
    });
    if ($("#select_day input").val() == "" || $("#select_day input").val() == "手动选择日期") {
      $("#select_day input").attr("class", "post_tiMe4 star").css("color", "#666666");
      $("#select_day").css("background-color", "none");
      $("#select_day input").val("手动选择日期");
    } else {
      $("#select_day input").attr("class", "post_tiMe4").css("color", "#FFFFFF");
      $("#select_day").css("background-color", "#0099e9");
    };
  }
  setTimeout(function() {
	  $(".tan_2wmCk p img").attr("src", $("#canvasimage img").attr('src'));
    }, 500);
  if($("#dt_review_form_content").val()!=""){
	  $(".dt_review_edit_r a").attr("class","dt_review_post_A able");
  }else{
	  $(".dt_review_edit_r a").attr("class","dt_review_post_A");
  }
  $("#dt_review_form_content").keyup(function (){
	  if($(this).val()!=""){
		  $(this).parent().parent().next(".dt_review_edit_r").children("a").attr("class","dt_review_post_A able");
	  }else{
		  $(this).parent().parent().next(".dt_review_edit_r").children("a").attr("class","dt_review_post_A");
	  }
  });
//赞
	$('#dt_like').mouseover(function(){
		var zan = $('#dt_like_list a');
		var zan_len = zan.length;
		if(parseInt($("#dt_like_count").html())==0){
	    	$("#dt_like_main").hide();
	    }else{
	    	$("#dt_like_main").show();
	    }
	}).mouseout(function(){
		$('.dt_like_main').hide();
	});
	$('#dt_like_list').mouseover(function(){
		$('#dt_like_main').show();
	}).mouseout(function(){
		$('.dt_like_main').hide();
	});
	
	if($(".tc_c_feiLi li").length!=0){
		if($(".detail_t_join a").html()=="去支付"||$(".detail_t_join a").html()=="已报名"){
			$(".tc_c_feiLi li").each(function(){
				$(this).unbind("click");
		    });
		}
	}
	if(_info._pre_View==1){
		$('a').addClass('tc_preview').attr('onclick','javascript:;');
		if($('.tan_2wmCk').length>0){
			$('.tan_2wmCk').remove()
		}
	}
	if(_info._type=="party"||_info._type=="article"||_info._type=="vote"){
		$("body").append('<div id="detail_r_pc2"></div>');
		_scrollR._tmph = $(document).scrollTop();
		_scrollR._init();
		_scrollR._basic();
		$("#detail_r_pc2").css("bottom",_scrollR._ch-_scrollR._rh-93+"px");
		setTimeout(function() {
		  _scrollR._init();
		  _scrollR._basic();
		  $("#detail_r_pc2").css("bottom",_scrollR._ch-_scrollR._rh-93+"px"); 
	    }, 500);
	}
	if(_info._shopId!=0 && _info._shopId!=""){
	  $("#attent_Btn").css("display","block");
	}
});

if(_info._type=="party"||_info._type=="article"||_info._type=="vote"){
	$(window).resize(function() {
	  _scrollR._init();
	  _scrollR._basic();
	});
	$(window).scroll(function() {
	  _scrollR._init();
	  _scrollR._go();
	});
}

var _scrollR = {//详情页右侧悬浮窗滚动规则设置
  _tmph:$(document).scrollTop(),//判断滚动条是上滚还是下滚的基准点
  _wh:0,//浏览器宽度
  _ch:0,//浏览器窗口高
  _bh:0,//页面内容整体高度
  _rh:0,//右侧悬浮窗高度
  _gh:0,//滚动条位置高度
  _th:0,//悬窗上部空余高
  _lh:0,
  _init:function(){
	_scrollR._wh = $("body").width();
	_scrollR._ch = $(window).height();
	_scrollR._bh = $("body").height();
	//_scrollR._rh = $("#detail_r_pc").height()+22;
	_scrollR._rh = $("#detail_r_pc").height();
	_scrollR._gh = $(document).scrollTop();
	if($(".dt_post_sucess").css("display")=="block"){
	  _scrollR._th = 299;
	}else{
	  _scrollR._th = 219;
	}
	if(_scrollR._wh>1189){
	  _scrollR._lh = (_scrollR._wh-1190)/2+930;
	}else{
	  _scrollR._lh = 930;
	}
	$("#detail_r_pc2").html($("#detail_r_pc").html());	
  },
  _basic:function(){
	if((_scrollR._ch-155)<_scrollR._rh){
	  if((_scrollR._th+_scrollR._rh-_scrollR._ch+81)<_scrollR._gh){
		$("#detail_r_pc2").css({"top":"auto","bottom":80+"px","left":_scrollR._lh+"px","display":"block"});
		$("#detail_r_pc").css({"visibility":"hidden"});
	  }else{
		$("#detail_r_pc2").css({"display":"none"});
		$("#detail_r_pc").css({"visibility":"visible"});
	  }
	}else{
	  if((_scrollR._th-71)<_scrollR._gh){
		$("#detail_r_pc2").css({"top":93+"px","bottom":"auto","left":_scrollR._lh+"px","display":"block"});
		$("#detail_r_pc").css({"visibility":"hidden"});
	  }else{
		$("#detail_r_pc2").css({"display":"none"});
		$("#detail_r_pc").css({"visibility":"visible"});
	  }
	}
  },
  _go:function(){
    if((_scrollR._ch-155)<_scrollR._rh){
  	  if((_scrollR._th-93)<_scrollR._gh){
  		$("#detail_r_pc2").css({"top":"auto","left":_scrollR._lh+"px","display":"block"});
  		$("#detail_r_pc").css({"visibility":"hidden"});
  		if(_scrollR._gh>_scrollR._tmph){
  		  $("#detail_r_pc2").css("bottom",parseInt($("#detail_r_pc2").css("bottom"))+_scrollR._gh-_scrollR._tmph+"px");
  		  if(parseInt($("#detail_r_pc2").css("bottom"))>80){
  			$("#detail_r_pc2").css("bottom",80+"px");
  		  }
  		}else if(_scrollR._gh<_scrollR._tmph){
  		  $("#detail_r_pc2").css("bottom",parseInt($("#detail_r_pc2").css("bottom"))+_scrollR._gh-_scrollR._tmph+"px");
  		  if(parseInt($("#detail_r_pc2").css("bottom"))<(_scrollR._ch-_scrollR._rh-93)){
  			$("#detail_r_pc2").css("bottom",_scrollR._ch-_scrollR._rh-93+"px");
  		  }
  		}
  	  }else{
  		$("#detail_r_pc2").css({"display":"none"});
  		$("#detail_r_pc").css({"visibility":"visible"});
  		$("#detail_r_pc2").css("bottom",_scrollR._ch-_scrollR._rh-93+"px");
  	  }
  	}else{
  	  if((_scrollR._th-93)<_scrollR._gh){
  		$("#detail_r_pc2").css({"top":93+"px","bottom":"auto","left":_scrollR._lh+"px","display":"block"});
  		$("#detail_r_pc").css({"visibility":"hidden"});
  	  }else{
  		$("#detail_r_pc2").css({"display":"none"});
  		$("#detail_r_pc").css({"visibility":"visible"});
  		$("#detail_r_pc2").css("bottom",_scrollR._ch-_scrollR._rh-93+"px");
  	  }
  	}
	_scrollR._tmph = _scrollR._gh;
  }
}

//关注
var _isFocus = {
  _init:function(){
//	  if(_t._get("focusLogin")=="no"&&_info._isFocus!=1){
//		  setTimeout(function() {
//			  _isFocus._add();
//          }, 3000);
//	  }
  },
  _add:function(){
    if(!_user._login()){
		//_t._set("focusLogin","no");
	    _user._toLogin();
	    return false;
	}
    var _shopId36 = _info._shopId.replace(/\,/g, '');
    _$(_api3._shopAttent, "focus_type=1&focus_shop_id=" + _shopId36, _isFocus._addok);
  },
  _addok: function(json, code) {
    if (code != 200) {
      _toast._show("关注失败!");
      return;
    }
    if(json.is_update==0){
		$(".focus_Cz").html('<a id="attent_Btn" href="javascript:void(0)">已关注</a>');
	    if(_user._inHudongba()){
	      _toast._show("关注成功!");
	    }else{
	      _tc._show('tc_attentOk');
	    }
	    //_t._set("focusLogin","");
    }else{
    	_toast._show("关注失败!");
    }
    
  }
}

//PC详情页评论输入框控制
var _reviewText = {
	_strL:"",
	_input1:function(){
		if($("#dt_review_form_content").val()!=""){
			$(".dt_review_post_A").attr("class","dt_review_post_A able");
			if(_._len($("#dt_review_form_content").val()) > 200){
				_toast._show("评论请在100字以内");
				_reviewText._cut('dt_review_form_content');
			}
		}else{
			$(".dt_review_post_A").attr("class","dt_review_post_A");
		}
	},
	_input2:function(){
		if($("#dt_review_form_content2").val()!=""){
			$("#dt_review_form_post2").attr("class","button_1_disabled able");
			if(_._len($("#dt_review_form_content2").val()) > 200){
				_toast._show("评论请在100字以内");
				_reviewText._cut('dt_review_form_content2');
			}
		}else{
			$("#dt_review_form_post2").attr("class","button_1_disabled");
		}
	},
	_cut:function(id){
		var str = $("#"+id).val();
		_reviewText._strL = str.length;
		for(i=_reviewText._strL;i>0;i--){
			str = str.substr(0, i-1);
			if(_._len(str)<201){
				$("#"+id).val(str);
				break;
			}
		};
	}
};




